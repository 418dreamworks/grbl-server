<!DOCTYPE html>
<html>
<head>
    <title>CNC Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace;
            background: #1a1a1a;
            color: #fff;
            margin: 0;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 20px;
        }
        h2 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #888;
            text-transform: uppercase;
            text-align: center;
        }
        .section { margin-bottom: 20px; }
        .row { display: flex; gap: 8px; margin-bottom: 8px; }
        button {
            background: #333;
            border: 1px solid #555;
            color: #fff;
            padding: 12px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            min-width: 70px;
        }
        button:hover { background: #444; }
        button:active { background: #0066cc; }
        button .key { display: block; font-size: 10px; color: #666; margin-top: 4px; }

        /* Color coding */
        .machine-ctrl button { background: #3a3a3a; border-color: #5a5a5a; }
        .z-buttons button, .work-zero button, .xy-grid button { flex: 1; min-height: 65px; }
        .z-buttons button { background: #2a4a2a; border-color: #3a6a3a; }
        .work-zero button { background: #4a2a2a; border-color: #6a3a3a; }
        .xy-grid button { background: #2a2a4a; border-color: #3a3a6a; padding: 15px; }
        .xy-grid button.work-zero { background: #4a2a2a; border-color: #6a3a3a; }
        .tool-buttons button { background: #4a4a2a; border-color: #6a6a3a; }
        .job-ctrl button { background: #2a4a4a; border-color: #3a6a6a; }
        .job-ctrl button.stop { background: #6a2a2a; border-color: #8a3a3a; }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .xy-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .jog-grid { display: grid; grid-template-columns: repeat(4, auto); gap: 8px; }
        .jog-grid button { padding: 12px 20px; font-size: 14px; }
        .step-selector .step-label, .spindle-ctrl .step-label { font-size: 12px; color: #888; margin-bottom: 4px; text-align: center; }
        .step-selector .step-btn { padding: 6px 10px; font-size: 12px; flex: 1; text-align: center; }
        .step-selector .step-btn.active { background: #4a6a4a; border-color: #6a8a6a; }
        .spindle-on { background: #2a4a2a !important; border-color: #3a6a3a !important; }
        .spindle-off { background: #4a2a2a !important; border-color: #6a3a3a !important; }
        .spindle-speed-btn { padding: 2px 8px !important; min-width: 30px !important; font-size: 10px !important; }

        .pos {
            font-family: monospace;
            font-size: 16px;
            padding: 15px;
            background: #222;
            border-radius: 4px;
            grid-column: 1 / -1;
        }
        .pos > div > div:first-child > span { margin-right: 8px; }
        .pos .label { color: #666; }
        .zero-btn {
            padding: 2px 0;
            width: 28px;
            min-width: 28px;
            max-width: 28px;
            font-size: 11px;
            margin-left: 2px;
            background: #3a3a3a;
            border-color: #555;
            text-align: center;
            box-sizing: border-box;
        }
        .zero-btn:hover { background: #4a4a4a; }

        .left-col { display: flex; flex-direction: column; justify-content: space-between; }
        .right-col { display: flex; flex-direction: column; }

        .camera {
            width: 100%;
            aspect-ratio: 4/3;
            background: #111;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #444;
        }
        .camera img { width: 100%; height: 100%; object-fit: contain; }

        .debug-console {
            grid-column: 1 / -1;
            background: #111;
            border: 1px solid #333;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #222;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
        }
        .debug-header:hover { background: #2a2a2a; }
        .debug-content {
            height: 150px;
            overflow-y: auto;
            padding: 8px 12px;
            display: none;
        }
        .debug-content.open { display: block; }
        .debug-line { color: #0f0; margin: 2px 0; white-space: pre-wrap; word-break: break-all; }
        .debug-line.sent { color: #ff0; }
        .debug-line.error { color: #f55; }
        .debug-line.info { color: #5af; }

        .status-bar {
            grid-column: 1 / -1;
            background: #222;
            border-radius: 4px;
            padding: 12px 15px;
        }
        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .machine-state {
            font-weight: bold;
            font-size: 14px;
            padding: 4px 12px;
            border-radius: 3px;
            background: #4a2a2a;
        }
        .machine-state.idle { background: #2a4a2a; }
        .machine-state.run { background: #2a4a4a; }
        .machine-state.hold { background: #4a4a2a; }
        .machine-state.alarm { background: #6a2a2a; }
        .machine-state.disconnected { background: #4a2a2a; }
        .file-name { color: #888; font-size: 13px; }
        .progress { font-family: monospace; color: #888; }
        .progress-bar {
            height: 4px;
            background: transparent;
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            background: #4a9a4a;
            transition: width 0.3s;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            min-width: 300px;
        }
        .modal h3 { margin: 0 0 15px 0; font-size: 16px; }
        .modal-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        .modal-row label { width: 30px; color: #888; }
        .modal-row input {
            flex: 1;
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #fff;
            font-family: monospace;
            font-size: 14px;
        }
        .modal-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .modal-buttons button { flex: 1; }
        .pos .label.clickable { cursor: pointer; text-decoration: underline; }
        .pos .label.clickable:hover { color: #aaa; }
        .unit { color: #888; margin-left: 10px; }
        .unit.clickable { cursor: pointer; text-decoration: underline; }
        .unit.clickable:hover { color: #aaa; }
        .pos-buttons button {
            padding: 6px 10px;
            font-size: 12px;
            min-width: auto;
        }
        .pos-buttons button .key {
            margin-top: 2px;
        }

        /* New: Port selector */
        .port-select {
            background: #1a1a1a;
            color: #fff;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 13px;
            font-family: monospace;
        }

        /* New: File controls */
        .file-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .file-controls button {
            padding: 4px 10px;
            font-size: 12px;
            min-width: auto;
        }

        /* New: Recovery info */
        .recovery-info {
            color: #6a6;
            font-size: 12px;
            font-family: monospace;
        }

        /* New: Resume line input */
        .resume-input {
            background: #1a1a1a;
            color: #fff;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 4px 8px;
            font-family: monospace;
            font-size: 13px;
            width: 80px;
            text-align: right;
        }

        /* New: Big red resume button */
        .resume-btn {
            background: #8a2a2a !important;
            border: 2px solid #aa3a3a !important;
            color: #fff;
            font-weight: bold;
            font-size: 12px !important;
            padding: 4px 12px !important;
            min-width: auto !important;
        }
        .resume-btn:hover {
            background: #aa3a3a !important;
        }
    </style>
</head>
<body>
    <!-- Status Bar (full width) -->
    <div class="status-bar">
        <div class="status-row">
            <div style="display: flex; align-items: center; gap: 15px;">
                <span style="font-size: 11px; color: #666; font-family: monospace;">v1.014</span>
                <span class="machine-state" id="machineState">DISCONNECTED</span>
                <!-- Port selector -->
                <select id="portSelect" class="port-select" onchange="changePort(this.value)">
                    <option value="">Select port...</option>
                </select>
                <button onclick="refreshPorts()" style="padding:4px 8px; font-size:11px; min-width:auto;">Refresh</button>
                <!-- File info -->
                <span class="file-name" id="fileName">No file loaded</span>
                <span class="progress" id="progress">--</span>
                <!-- File stats (feed/plunge/spindle) -->
                <span id="fileStats" style="font-size: 11px; color: #888; font-family: monospace;"></span>
                <!-- Recovery info -->
                <span class="recovery-info" id="recoveryInfo">Safe: --</span>
            </div>
            <div class="btn-container" style="display: flex; flex-direction: column; gap: 4px; width: 468px;">
                <div id="currentLine" style="display:none;">--</div>
                <div style="display: flex; gap: 16px;">
                <div class="job-ctrl" style="display: flex; gap: 8px; width: 50%;">
                    <button id="btnRun" style="flex: 1; background: #2a4a2a; border-color: #3a6a3a;" onclick="jobStart()">Run</button>
                    <button id="btnPause" style="flex: 1; background: #4a4a2a; border-color: #6a6a3a;" onclick="jobPause()">Pause</button>
                    <button id="btnStop" style="flex: 1; background: #4a2a2a; border-color: #6a3a3a;" onclick="jobStop()">Stop</button>
                </div>
                <div class="machine-ctrl" style="display: flex; gap: 8px; width: 50%;">
                    <button id="btnUnlock" style="flex: 1;" onclick="unlock()">Unlock</button>
                    <button id="btnReset" style="flex: 1;" onclick="doReset()">Reset</button>
                    <button id="btnHome" style="flex: 1;" onclick="runMacro('HOMING')">Home</button>
                </div>
                </div>
            </div>
        </div>
        <!-- File load + resume row -->
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <div class="file-controls">
                <input type="file" id="fileInput" accept=".nc,.gcode,.ngc,.tap" style="display:none" onchange="handleFileSelect(event)">
                <button onclick="document.getElementById('fileInput').click()" style="background:#3a3a3a;">Load File</button>
            </div>
            <span style="color:#666; font-size:12px;">Resume from line:</span>
            <input type="number" id="resumeLine" class="resume-input" placeholder="auto" min="1">
            <button class="resume-btn" onclick="confirmResume()">RESUME FROM LINE</button>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    </div>

    <!-- Position Display (full width) -->
    <div class="pos">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
            <div>
                <span class="label clickable" onclick="openWorkModal()" style="display:inline-block;width:40px;">Work:</span>
                <span><span style="color: #fc0; cursor:pointer;" onclick="cmd('$HX')" title="Home X">X:</span> <span id="workX" style="display:inline-block;width:8ch;text-align:right;">---.---</span><button class="zero-btn" onclick="cmd('G10 L20 P1 X0')">&#x2299;0</button></span>
                <span><span style="color: #fc0; cursor:pointer;" onclick="cmd('$HY')" title="Home Y">Y:</span> <span id="workY" style="display:inline-block;width:8ch;text-align:right;">---.---</span><button class="zero-btn" onclick="cmd('G10 L20 P1 Y0')">&#x2299;0</button></span>
                <span><span style="color: #fc0; cursor:pointer;" onclick="cmd('$HZ')" title="Home Z">Z:</span> <span id="workZ" style="display:inline-block;width:8ch;text-align:right;">---.---</span><button class="zero-btn" onclick="zeroZAndSetZ()">&#x2299;0</button></span>
                <span><span style="color: #fc0; cursor:pointer;" onclick="homeA()" title="Home A">A:</span> <span id="workA" style="display:inline-block;width:8ch;text-align:right;">---.---</span><button class="zero-btn" onclick="cmd('G10 L20 P1 A0')">&#x2299;0</button></span>
                <span class="unit clickable" onclick="toggleUnits()" id="unitWork">mm</span>
            </div>
            <span id="spindleRPM" style="font-size: 20px; font-weight: bold; white-space: nowrap;"><span style="display:inline-block;width:50px;text-align:right;">--</span> <span style="display:inline-block;width:55px;">RPM</span></span>
            <div style="display: flex; gap: 4px; align-items: center;">
                <button id="spindleOnBtn" onclick="spindleOn()" class="spindle-off" style="min-width: auto; padding: 4px 10px; font-size: 13px;">ON</button>
                <button onclick="spindleOff()" style="min-width: auto; padding: 4px 10px; font-size: 13px; background: #4a2a2a; border-color: #6a3a3a;">OFF</button>
                <button onclick="setSpindleSpeed(9000)" style="min-width: auto; padding: 4px 8px; font-size: 12px;">9K</button>
                <button onclick="setSpindleSpeed(15000)" style="min-width: auto; padding: 4px 8px; font-size: 12px;">15K</button>
                <button onclick="setSpindleSpeed(24000)" style="min-width: auto; padding: 4px 8px; font-size: 12px;">24K</button>
            </div>
            <div style="display: flex; gap: 2px; align-items: center;">
                <button onclick="spindleOverride(-10)" style="min-width: auto; padding: 4px 6px; font-size: 15px;">-10%</button>
                <button onclick="spindleOverride(-1)" style="min-width: auto; padding: 4px 6px; font-size: 15px;">-1%</button>
                <span id="spindleOverride" onclick="spindleOverride(0)" style="font-family: monospace; width: 5ch; display: inline-block; text-align: center; font-size: 15px; font-weight: bold; background: #222; padding: 4px 4px; border-radius: 4px; cursor: pointer;" title="Click to reset to 100%">100%</span>
                <button onclick="spindleOverride(1)" style="min-width: auto; padding: 4px 6px; font-size: 15px;">+1%</button>
                <button onclick="spindleOverride(10)" style="min-width: auto; padding: 4px 6px; font-size: 15px;">+10%</button>
            </div>
        </div>
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <span class="label" style="display:inline-block;width:40px;">Mach:</span>
                <span><span style="color: #fc0;">X:</span> <span id="machX" style="display:inline-block;width:8ch;text-align:right;">---.---</span><button class="zero-btn goto-btn" onclick="cmd('$HX')">&#x2192;0</button></span>
                <span><span style="color: #fc0;">Y:</span> <span id="machY" style="display:inline-block;width:8ch;text-align:right;">---.---</span><button class="zero-btn goto-btn" onclick="cmd('$HY')">&#x2192;0</button></span>
                <span><span style="color: #fc0;">Z:</span> <span id="machZ" style="display:inline-block;width:8ch;text-align:right;">---.---</span><button class="zero-btn goto-btn" onclick="cmd('$HZ')">&#x2192;0</button></span>
                <span><span style="color: #fc0;">A:</span> <span id="machA" style="display:inline-block;width:8ch;text-align:right;">---.---</span><button class="zero-btn goto-btn" onclick="homeA()">&#x2192;0</button></span>
                <span class="unit clickable" onclick="toggleUnits()" id="unitMach">mm</span>
            </div>
            <span id="machineSpeed" style="font-size: 20px; font-weight: bold; white-space: nowrap;"><span style="display:inline-block;width:50px;text-align:right;">0</span> <span style="display:inline-block;width:55px;">mm/min</span></span>
            <div style="display: flex; gap: 2px; align-items: center;">
                <button onclick="feedOverride(-10)" style="min-width: auto; padding: 4px 6px; font-size: 15px;">-10%</button>
                <button onclick="feedOverride(-1)" style="min-width: auto; padding: 4px 6px; font-size: 15px;">-1%</button>
                <span id="feedRate" onclick="feedOverride(0)" style="font-family: monospace; width: 5ch; display: inline-block; text-align: center; font-size: 15px; font-weight: bold; background: #222; padding: 4px 4px; border-radius: 4px; cursor: pointer;" title="Click to reset to 100%">100%</span>
                <button onclick="feedOverride(1)" style="min-width: auto; padding: 4px 6px; font-size: 15px;">+1%</button>
                <button onclick="feedOverride(10)" style="min-width: auto; padding: 4px 6px; font-size: 15px;">+10%</button>
            </div>
        </div>
    </div>

    <!-- Left Column -->
    <div class="left-col">
        <div class="section">
            <div class="xy-grid">
                <button onclick="gotoXY(workMaxX-MARGIN, MARGIN)">&#x2196;</button>
                <button onclick="gotoXY(workMaxX/2, MARGIN)">&#x2191;</button>
                <button onclick="gotoXY(MARGIN, MARGIN)">&#x2197;</button>
                <button onclick="gotoXY(workMaxX-MARGIN, workMaxY/2)">&#x2190;</button>
                <button onclick="gotoXY(workMaxX/2, workMaxY/2)">&#x25CF;</button>
                <button onclick="gotoXY(MARGIN, workMaxY/2)">&#x2192;</button>
                <button onclick="gotoXY(workMaxX-MARGIN, workMaxY-MARGIN)">&#x2199;</button>
                <button onclick="gotoXY(workMaxX/2, workMaxY-MARGIN)">&#x2193;</button>
                <button onclick="gotoXY(MARGIN, workMaxY-MARGIN)">&#x2198;</button>
            </div>
            <div class="xy-grid" style="margin-top: 8px;">
                <button style="background:#4a2a2a; border-color:#6a3a3a;" onclick="cmd('G54 G0 X0 Y0')">X0 Y0</button>
                <button style="background:#4a2a2a; border-color:#6a3a3a;" onclick="cmd('G54 G0 Z0')">Z0</button>
                <button style="background:#4a2a2a; border-color:#6a3a3a;" onclick="cmd('G54 G0 Z10')">Z10</button>
            </div>
        </div>
        <div class="section" style="margin-top: 8px; flex: 1; display: flex; flex-direction: column;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; flex: 1;">
                <button onclick="jog('X', 1)" style="font-size:11px; min-width:0; min-height:0;">X+<span class="key">[&#x2192;]</span></button>
                <button onclick="jog('Y', 1)" style="font-size:11px; min-width:0; min-height:0;">Y+<span class="key">[&#x2191;]</span></button>
                <button onclick="jog('Z', 1)" style="font-size:11px; min-width:0; min-height:0;">Z+<span class="key">[Fn&#x2191;]</span></button>
                <button onclick="jog('A', 1)" style="font-size:11px; min-width:0; min-height:0;">A+<span class="key">[Fn&#x2192;]</span></button>
                <button onclick="jog('X', -1)" style="font-size:11px; min-width:0; min-height:0;">X-<span class="key">[&#x2190;]</span></button>
                <button onclick="jog('Y', -1)" style="font-size:11px; min-width:0; min-height:0;">Y-<span class="key">[&#x2193;]</span></button>
                <button onclick="jog('Z', -1)" style="font-size:11px; min-width:0; min-height:0;">Z-<span class="key">[Fn&#x2193;]</span></button>
                <button onclick="jog('A', -1)" style="font-size:11px; min-width:0; min-height:0;">A-<span class="key">[Fn&#x2190;]</span></button>
            </div>
            <div class="step-selector" style="margin-top: 4px;">
                <div class="step-label" id="stepLabel" style="display:flex;justify-content:space-between;font-size:10px;"><span style="color:#555">&lt;</span><span>Step (mm)</span><span style="color:#555">&gt;</span></div>
                <div id="stepButtons" style="display: flex; gap: 3px;">
                    <button class="step-btn" onclick="setStep(0.025, this)" style="padding:4px 6px; font-size:10px;">0.025</button>
                    <button class="step-btn" onclick="setStep(0.25, this)" style="padding:4px 6px; font-size:10px;">0.25</button>
                    <button class="step-btn active" onclick="setStep(2.5, this)" style="padding:4px 6px; font-size:10px;">2.5</button>
                    <button class="step-btn" onclick="setStep(25, this)" style="padding:4px 6px; font-size:10px;">25</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Middle Column -->
    <div class="mid-col">
        <div class="section">
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <!-- Macros -->
                <div class="tool-buttons" style="display: flex; gap: 8px;">
                    <button style="flex: 1;" onclick="runMacro('tool_change')">Tool Change</button>
                </div>
                <!-- Zero Probes -->
                <div class="tool-buttons" style="display: flex; gap: 8px;">
                    <button style="flex: 1; background: #2a3a4a; border-color: #3a5a7a;" onclick="runProbe('probe_z')">Z</button>
                    <button style="flex: 1; background: #2a3a4a; border-color: #3a5a7a;" onclick="showProbeModal('probe_x')">X</button>
                    <button style="flex: 1; background: #2a3a4a; border-color: #3a5a7a;" onclick="showProbeModal('probe_y')">Y</button>
                    <button style="flex: 1; background: #2a3a4a; border-color: #3a5a7a;" onclick="showProbeModal('probe_xy')">XY</button>
                    <button style="flex: 1; background: #2a3a4a; border-color: #3a5a7a;" onclick="showProbeModal('probe_xyz')">XYZ</button>
                </div>
                <!-- Status -->
                <div>
                    <button id="debugInfo" style="width: 100%; padding: 12px; background: #3a3a3a; border-color: #555;">&#x2713; Synced</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column - Camera -->
    <div class="right-col">
        <div class="section" style="flex: 1;">
            <div class="camera" id="camera" style="height: 100%;">
                <span>No camera feed</span>
            </div>
        </div>
    </div>

    <!-- Debug Console -->
    <div class="debug-console">
        <div class="debug-header">
            <span onclick="toggleDebug()" style="cursor:pointer;">Debug Console</span>
            <input type="text" id="gcodeInput" placeholder="G-code..."
                   style="flex: 1; margin: 0 8px; padding: 4px 8px; background: #222; border: 1px solid #444;
                          border-radius: 4px; color: #fff; font-family: monospace; font-size: 12px;"
                   onkeydown="if(event.key==='Enter'){sendGcodeInput();event.preventDefault();}">
            <button onclick="sendGcodeInput()" style="padding: 4px 12px; font-size: 11px; margin-right: 8px;">Send</button>
            <button onclick="copyDebugLog(event)" style="padding:2px 8px;font-size:11px;margin-right:4px;">Copy</button>
            <button id="statusToggle" onclick="toggleStatusLog()" style="padding:2px 8px;font-size:11px;margin-right:8px;background:#2a4a2a;">Status</button>
            <span id="debugToggle" onclick="toggleDebug()" style="cursor:pointer;">&#x25B2;</span>
        </div>
        <div class="debug-content open" id="debugContent">
            <div id="debugLog"></div>
        </div>
    </div>

    <!-- M0 Continue Overlay -->
    <div id="continueOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); z-index:1000; align-items:center; justify-content:center;" onclick="if(event.target===this)hideContinue()">
        <button onclick="macroContinue(); hideContinue();" style="padding: 80px 160px; font-size: 72px; font-weight: bold; background: #2a6a2a; border: 6px solid #4a9a4a; color: #fff; border-radius: 24px; cursor: pointer; box-shadow: 0 0 60px rgba(0,255,0,0.3); text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
            CONTINUE<br><span style="font-size: 24px; color: #aaa;">Swap tool, then press to resume</span>
        </button>
    </div>

    <!-- Confirm Dialog -->
    <div class="modal" id="confirmModal" onclick="if(event.target===this)confirmResolve(false)">
        <div class="modal-content" style="min-width: 300px; text-align: center;">
            <h3 id="confirmMsg">Confirm</h3>
            <div class="modal-buttons">
                <button onclick="confirmResolve(false)" style="background:#4a2a2a;">No</button>
                <button onclick="confirmResolve(true)" style="background:#2a4a2a;">Yes</button>
            </div>
        </div>
    </div>

    <!-- Work Coordinate Modal -->
    <div class="modal" id="workModal" onclick="if(event.target===this)closeWorkModal()">
        <div class="modal-content">
            <h3>Set Work Coordinates</h3>
            <div class="modal-row">
                <label>X</label>
                <input type="number" id="modalX" step="0.001">
            </div>
            <div class="modal-row">
                <label>Y</label>
                <input type="number" id="modalY" step="0.001">
            </div>
            <div class="modal-row">
                <label>Z</label>
                <input type="number" id="modalZ" step="0.001">
            </div>
            <div class="modal-row">
                <label>A</label>
                <input type="number" id="modalA" step="0.001">
            </div>
            <div class="modal-buttons">
                <button onclick="closeWorkModal()">Cancel</button>
                <button onclick="applyWorkCoords()" style="background:#2a4a2a;">Apply</button>
            </div>
        </div>
    </div>

    <!-- Probe Tool Diameter Modal -->
    <div class="modal" id="probeModal" onclick="if(event.target===this)closeProbeModal()">
        <div class="modal-content" style="min-width: 280px;">
            <h3>Select Tool Diameter</h3>
            <div style="display: flex; flex-direction: column; gap: 12px; margin: 15px 0;">
                <button onclick="runProbeWithDia(6.35)" style="padding: 15px; font-size: 16px; background: #2a4a2a; border-color: #3a6a3a;">
                    1/4" (6.35mm)
                </button>
                <button onclick="runProbeWithDia(3.175)" style="padding: 15px; font-size: 16px; background: #2a4a4a; border-color: #3a6a6a;">
                    1/8" (3.175mm)
                </button>
            </div>
            <div class="modal-buttons">
                <button onclick="closeProbeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION ==========
        const CAMERA_URL = 'http://192.168.68.105:8080/?action=stream';

        // GRBL settings (populated from server)
        let workMaxX = 400, workMaxY = 400, workMaxZ = 100, workMaxA = 99999;
        const MARGIN = 2;
        let spindleMaxRPM = 24000, spindleMinRPM = 9000;

        // Machine state
        let machPosX = 0, machPosY = 0, machPosZ = 0, machPosA = 0;
        let pendingX = 0, pendingY = 0, pendingZ = 0, pendingA = 0;
        let lastMachineState = '';
        let pendingInitialized = false;
        let connected = false;
        let currentPort = '';
        let setZDone = false;
        let spindleWasRunning = false;
        let lastSpindleSpeed = 15000;
        let streamerPaused = false;
        let fileLoaded = false;
        let lastSafeLine = null;
        let lastSafeGcode = '';
        let showStatusLog = true;
        let macroRunning = false;

        // ========== WEBSOCKET CONNECTION ==========
        let ws;

        function getWsUrl() {
            // When served by the Python server, connect to same host
            // For local development, this won't connect (no server) but UI still works
            return 'ws://' + window.location.host + '/ws';
        }

        function connect() {
            try {
                ws = new WebSocket(getWsUrl());
            } catch (e) {
                debugLog('WebSocket not available (local preview mode)', 'info');
                return;
            }

            ws.onopen = () => {
                debugLog('WebSocket connected', 'info');
                connected = true;
                document.getElementById('machineState').textContent = 'CONNECTED';
                document.getElementById('machineState').className = 'machine-state idle';
                wsSend({ type: 'list_ports' });
                wsSend({ type: 'settings' });
                updateButtonStates();
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleMessage(msg);
            };

            ws.onclose = () => {
                connected = false;
                document.getElementById('machineState').textContent = 'DISCONNECTED';
                document.getElementById('machineState').className = 'machine-state disconnected';
                updateButtonStates();
                setTimeout(connect, 2000);
            };

            ws.onerror = () => {
                debugLog('WebSocket error', 'error');
            };
        }

        function wsSend(msg) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(msg));
            }
        }

        // ========== MESSAGE HANDLER ==========
        function handleMessage(msg) {
            switch (msg.type) {
                case 'status':       handleStatus(msg); break;
                case 'serial_read':  if (showStatusLog || !msg.line.startsWith('<')) debugLog('< ' + msg.line); break;
                case 'serial_write': debugLog('> ' + msg.line, 'sent'); break;
                case 'response':     handleResponse(msg); break;
                case 'connected':    handleConnected(msg); break;
                case 'disconnected': handleDisconnected(); break;
                case 'ports':        handlePorts(msg); break;
                case 'settings':     handleSettings(msg); break;
                case 'probe':        handleProbe(msg); break;
                case 'alarm':        handleAlarm(msg); break;
                case 'file_status':  handleFileStatus(msg); break;
                case 'file_done':    handleFileDone(msg); break;
                case 'file_error':   handleFileError(msg); break;
                case 'macro_status': handleMacroStatus(msg); break;
                case 'macro_done':   handleMacroDone(msg); break;
                case 'macro_error':  handleMacroError(msg); break;
                case 'macro_log':    handleMacroLog(msg); break;
                case 'error':        debugLog('ERROR: ' + msg.message, 'error'); break;
            }
        }

        // ========== STATUS HANDLING ==========
        function handleStatus(msg) {
            const factor = currentUnit === 'in' ? 1/25.4 : 1;
            const decimals = 3;

            // Work position
            if (msg.wpos) {
                document.getElementById('workX').textContent = (msg.wpos.x * factor).toFixed(decimals);
                document.getElementById('workY').textContent = (msg.wpos.y * factor).toFixed(decimals);
                document.getElementById('workZ').textContent = (msg.wpos.z * factor).toFixed(decimals);
                document.getElementById('workA').textContent = (msg.wpos.a || 0).toFixed(3);
            }

            // Machine position
            if (msg.mpos) {
                machPosX = msg.mpos.x;
                machPosY = msg.mpos.y;
                machPosZ = msg.mpos.z;
                machPosA = msg.mpos.a || 0;

                const currentState = (msg.state || '').toUpperCase();
                const needsSync = !pendingInitialized ||
                                  (lastMachineState === 'ALARM' && currentState === 'IDLE') ||
                                  (lastMachineState === 'HOME' && currentState === 'IDLE');

                if (needsSync) {
                    pendingX = machPosX; pendingY = machPosY;
                    pendingZ = machPosZ; pendingA = machPosA;
                    pendingInitialized = true;
                }

                // Auto-sync when IDLE with desync
                if (currentState === 'IDLE') {
                    const maxDesync = Math.max(
                        Math.abs(pendingX - machPosX), Math.abs(pendingY - machPosY),
                        Math.abs(pendingZ - machPosZ), Math.abs(pendingA - machPosA)
                    );
                    if (maxDesync > 0.1) {
                        pendingX = machPosX; pendingY = machPosY;
                        pendingZ = machPosZ; pendingA = machPosA;
                    }
                    document.getElementById('debugInfo').style.background = '#3a3a3a';
                    document.getElementById('debugInfo').textContent = '\u2713 Synced';
                } else {
                    document.getElementById('debugInfo').style.background = '#3a3a3a';
                    document.getElementById('debugInfo').textContent = 'Moving...';
                }

                document.getElementById('machX').textContent = (machPosX * factor).toFixed(decimals);
                document.getElementById('machY').textContent = (machPosY * factor).toFixed(decimals);
                document.getElementById('machZ').textContent = (machPosZ * factor).toFixed(decimals);
                document.getElementById('machA').textContent = machPosA.toFixed(3);

                lastMachineState = currentState;
            }

            // Machine state badge
            if (msg.state) {
                const stateEl = document.getElementById('machineState');
                const s = msg.state.toUpperCase();
                stateEl.textContent = s;
                stateEl.className = 'machine-state ' + msg.state.toLowerCase().split(':')[0];
            }

            // Overrides
            if (msg.feed_override !== undefined) {
                currentFeedOverride = msg.feed_override;
                document.getElementById('feedRate').textContent = msg.feed_override + '%';
            }
            if (msg.spindle_override !== undefined) {
                currentSpindleOverride = msg.spindle_override;
                document.getElementById('spindleOverride').textContent = msg.spindle_override + '%';
            }

            // Spindle RPM
            if (msg.spindle_speed !== undefined) {
                if (msg.spindle_speed > 0) lastSpindleSpeed = msg.spindle_speed;
                document.getElementById('spindleRPM').innerHTML =
                    '<span style="display:inline-block;width:50px;text-align:right;">' + (msg.spindle_speed || 0) +
                    '</span> <span style="display:inline-block;width:55px;">RPM</span>';
                // Update spindle running state
                spindleRunning = msg.spindle_speed > 0;
                updateSpindleButton();
            }

            // Feed rate
            if (msg.feed_rate !== undefined) {
                const feed = msg.feed_rate || 0;
                const unit = currentUnit === 'in' ? 'in' : 'mm';
                const displayFeed = currentUnit === 'in' ? Math.round(feed / 25.4) : Math.round(feed);
                document.getElementById('machineSpeed').innerHTML =
                    '<span style="display:inline-block;width:50px;text-align:right;">' + displayFeed +
                    '</span> <span style="display:inline-block;width:55px;">' + unit + '/min</span>';
            }

            updateButtonStates();
        }

        function handleResponse(msg) {
            if (msg.result && msg.result.startsWith('error')) {
                debugLog('ERROR: ' + msg.result + ' (cmd: ' + msg.to + ')', 'error');
            }
        }

        function handleConnected(msg) {
            connected = true;
            currentPort = msg.port;
            document.getElementById('machineState').textContent = 'CONNECTED';
            document.getElementById('machineState').className = 'machine-state idle';
            debugLog('Connected to ' + msg.port, 'info');
            updateButtonStates();
        }

        function handleDisconnected() {
            connected = false;
            document.getElementById('machineState').textContent = 'DISCONNECTED';
            document.getElementById('machineState').className = 'machine-state disconnected';
            updateButtonStates();
        }

        function handlePorts(msg) {
            const select = document.getElementById('portSelect');
            select.innerHTML = '<option value="">Select port...</option>';
            (msg.ports || []).forEach(port => {
                const opt = document.createElement('option');
                opt.value = port;
                opt.textContent = port;
                if (port === currentPort) opt.selected = true;
                select.appendChild(opt);
            });
        }

        function handleSettings(msg) {
            const s = msg.settings || {};
            if (s['$130']) workMaxX = parseFloat(s['$130']);
            if (s['$131']) workMaxY = parseFloat(s['$131']);
            if (s['$132']) workMaxZ = parseFloat(s['$132']);
            if (s['$133']) workMaxA = parseFloat(s['$133']);
            if (s['$30']) spindleMaxRPM = Math.floor(parseFloat(s['$30']) / 1000) * 1000;
            if (s['$31']) spindleMinRPM = Math.ceil(parseFloat(s['$31']) / 1000) * 1000;
            document.getElementById('debugInfo').textContent =
                '$130: ' + workMaxX + ' | $131: ' + workMaxY + ' | $132: ' + workMaxZ;
        }

        function handleProbe(msg) {
            debugLog('\u2605 PROBE ' + (msg.success ? 'HIT' : 'MISS') +
                ' X=' + msg.x.toFixed(3) + ' Y=' + msg.y.toFixed(3) + ' Z=' + msg.z.toFixed(3), 'info');
        }

        function handleAlarm(msg) {
            debugLog('ALARM:' + msg.code + ' ' + (msg.message || ''), 'error');
            lastMachineState = 'ALARM';
            const stateEl = document.getElementById('machineState');
            stateEl.textContent = 'ALARM';
            stateEl.className = 'machine-state alarm';
            updateButtonStates();
        }

        // ========== FILE STREAMING ==========
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                wsSend({ type: 'file_upload', filename: file.name, content: e.target.result });
                document.getElementById('fileName').textContent = file.name;
                fileLoaded = true;
                debugLog('File loaded: ' + file.name, 'info');
            };
            reader.readAsText(file);
        }

        function confirmResume() {
            const lineInput = document.getElementById('resumeLine');
            const fromLine = lineInput.value ? parseInt(lineInput.value) : undefined;
            if (!fileLoaded) {
                debugLog('No file loaded', 'error');
                return;
            }
            const msg = fromLine
                ? 'Start streaming from line ' + fromLine + '?'
                : 'Start streaming from the beginning?';
            showConfirm(msg, (yes) => {
                if (!yes) return;
                const payload = { type: 'file_start' };
                if (fromLine) payload.from_line = fromLine;
                wsSend(payload);
            });
        }

        function handleFileStatus(msg) {
            document.getElementById('fileName').textContent = msg.filename || '';
            const pct = (msg.percent || 0).toFixed(1);
            document.getElementById('progress').textContent =
                msg.current + '/' + msg.total + ' (' + pct + '%)';
            document.getElementById('progressFill').style.width = pct + '%';
            if (msg.current_gcode) {
                document.getElementById('gcodeInput').placeholder = 'L' + msg.current + ': ' + msg.current_gcode;
            }
            // Update recovery info
            if (msg.last_safe_line) {
                lastSafeLine = msg.last_safe_line;
                lastSafeGcode = msg.last_safe_gcode || '';
                document.getElementById('recoveryInfo').textContent = 'Safe: L' + msg.last_safe_line;
                document.getElementById('resumeLine').placeholder = msg.last_safe_line;
            }
            // Display file analysis stats
            if (msg.analysis) {
                const a = msg.analysis;
                let stats = [];
                if (a.max_feed > 0) stats.push('F' + a.max_feed);
                if (a.max_plunge > 0) stats.push('P' + a.max_plunge);
                if (a.max_spindle > 0) {
                    if (a.min_spindle === a.max_spindle) {
                        stats.push('S' + a.max_spindle);
                    } else {
                        stats.push('S' + a.min_spindle + '-' + a.max_spindle);
                    }
                }
                if (a.tool_changes > 0) stats.push('T' + a.tool_changes);
                document.getElementById('fileStats').textContent = stats.join(' | ');
            }
        }

        function handleFileDone(msg) {
            debugLog('=== FILE COMPLETE: ' + msg.filename + ' (' + msg.total + ' lines) ===', 'info');
            document.getElementById('progressFill').style.width = '100%';
        }

        function handleFileError(msg) {
            debugLog('FILE ERROR at line ' + msg.line + ': ' + msg.error + ' [' + msg.gcode + ']', 'error');
        }

        // ========== MACRO HANDLING ==========
        function handleMacroLog(msg) {
            // Log macro progress to debug console (no modal)
            debugLog('[' + (msg.name || 'MACRO') + '] ' + msg.message, 'info');
            // Show G-code commands in the input box (messages starting with "> ")
            if (msg.message && msg.message.startsWith('> ')) {
                const gcode = msg.message.substring(2);
                const input = document.getElementById('gcodeInput');
                input.value = gcode;
                input.style.color = '#0f0';  // Green to show it's macro-generated
            }
        }

        function handleMacroStatus(msg) {
            macroRunning = true;
            updateButtonStates();
            // Log status to console instead of showing modal
            debugLog('[' + (msg.name || 'MACRO') + '] Step ' + msg.step + '/' + msg.total + ': ' + msg.description, 'info');
            // Show CONTINUE overlay when waiting for user (tool change)
            if (msg.waiting) {
                document.getElementById('continueOverlay').style.display = 'flex';
            }
        }

        function handleMacroDone(msg) {
            macroRunning = false;
            document.getElementById('continueOverlay').style.display = 'none';
            const input = document.getElementById('gcodeInput');
            input.value = '';
            input.style.color = '#fff';  // Reset color
            debugLog('=== MACRO COMPLETE: ' + msg.name + ' ===', 'info');
            if (msg.name === 'set_z') setZDone = true;
            updateButtonStates();
        }

        function handleMacroError(msg) {
            macroRunning = false;
            document.getElementById('continueOverlay').style.display = 'none';
            const input = document.getElementById('gcodeInput');
            input.value = '';
            input.style.color = '#fff';  // Reset color
            debugLog('MACRO ERROR (' + msg.name + '): ' + msg.error, 'error');
            updateButtonStates();
        }

        function macroCancel() {
            wsSend({ type: 'macro_cancel' });
            document.getElementById('continueOverlay').style.display = 'none';
        }

        function macroContinue() {
            wsSend({ type: 'macro_continue' });
        }

        // ========== COMMANDS ==========
        function cmd(gcode) {
            if (!connected) return;
            wsSend({ type: 'gcode', line: gcode });
        }

        function sendRealtime(byte) {
            if (!connected) return;
            wsSend({ type: 'realtime', byte: byte });
        }

        function sendGcodeInput() {
            const input = document.getElementById('gcodeInput');
            const gcode = input.value.trim();
            if (gcode) {
                cmd(gcode);
                input.value = '';
            }
            input.focus();
        }

        function unlock() { wsSend({ type: 'unlock' }); }
        function doReset() { wsSend({ type: 'reset' }); }

        function changePort(port) {
            if (port) wsSend({ type: 'connect', port: port });
        }

        function refreshPorts() {
            wsSend({ type: 'list_ports' });
        }

        // ========== MOTION ==========
        function isWithinLimits(targetX, targetY, targetZ, targetA) {
            if (targetX !== null && (targetX > 0.01 || targetX < -workMaxX)) return false;
            if (targetY !== null && (targetY > 0.01 || targetY < -workMaxY)) return false;
            if (targetZ !== null && (targetZ > 0.01 || targetZ < -workMaxZ)) return false;
            return true;
        }

        function showBlocked(msg) {
            const el = document.getElementById('debugInfo');
            const orig = el.style.background;
            el.style.background = '#6a2a2a';
            el.textContent = msg;
            setTimeout(() => {
                el.style.background = orig;
                el.textContent = '$130: ' + workMaxX + ' | $131: ' + workMaxY + ' | $132: ' + workMaxZ;
            }, 2000);
        }

        function gotoXY(x, y) {
            const targetX = -x;
            const targetY = -y;
            if (!isWithinLimits(targetX, targetY, null)) {
                showBlocked('BLOCKED: X' + targetX.toFixed(1) + ' Y' + targetY.toFixed(1));
                return;
            }
            pendingX = targetX;
            pendingY = targetY;
            cmd('G53 G0 X' + targetX.toFixed(1) + ' Y' + targetY.toFixed(1));
        }

        let jogStep = 2.5;
        let jogCounter = 0;

        function jog(axis, dir) {
            jogCounter++;
            const dist = jogStep * dir;
            let targetX = pendingX, targetY = pendingY, targetZ = pendingZ, targetA = pendingA;
            if (axis === 'X') targetX += dist;
            if (axis === 'Y') targetY += dist;
            if (axis === 'Z') targetZ += dist;
            if (axis === 'A') targetA += dist;

            if (!isWithinLimits(targetX, targetY, targetZ, targetA)) {
                showBlocked('BLOCKED: ' + axis + (dist > 0 ? '+' : '') + dist + ' \u2192 ' +
                    (axis === 'X' ? targetX : axis === 'Y' ? targetY : axis === 'Z' ? targetZ : targetA).toFixed(1));
                return;
            }

            pendingX = targetX; pendingY = targetY;
            pendingZ = targetZ; pendingA = targetA;
            cmd('G91 G0 ' + axis + dist);
            cmd('G90');
        }

        function setStep(step, btn) {
            jogStep = step;
            document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // ========== OVERRIDES ==========
        let currentFeedOverride = 100;
        function feedOverride(delta) {
            if (!connected) return;
            let byte;
            if (delta === 0) { byte = 0x90; currentFeedOverride = 100; }
            else if (delta === 10) { byte = 0x91; currentFeedOverride = Math.min(200, currentFeedOverride + 10); }
            else if (delta === -10) { byte = 0x92; currentFeedOverride = Math.max(10, currentFeedOverride - 10); }
            else if (delta === 1) { byte = 0x93; currentFeedOverride = Math.min(200, currentFeedOverride + 1); }
            else if (delta === -1) { byte = 0x94; currentFeedOverride = Math.max(10, currentFeedOverride - 1); }
            if (byte) sendRealtime(byte);
            document.getElementById('feedRate').textContent = currentFeedOverride + '%';
        }

        let currentSpindleOverride = 100;
        function spindleOverride(delta) {
            if (!connected) return;
            let byte;
            if (delta === 0) { byte = 0x99; currentSpindleOverride = 100; }
            else if (delta === 10) { byte = 0x9A; currentSpindleOverride = Math.min(200, currentSpindleOverride + 10); }
            else if (delta === -10) { byte = 0x9B; currentSpindleOverride = Math.max(10, currentSpindleOverride - 10); }
            else if (delta === 1) { byte = 0x9C; currentSpindleOverride = Math.min(200, currentSpindleOverride + 1); }
            else if (delta === -1) { byte = 0x9D; currentSpindleOverride = Math.max(10, currentSpindleOverride - 1); }
            if (byte) sendRealtime(byte);
            document.getElementById('spindleOverride').textContent = currentSpindleOverride + '%';
        }

        let spindleRunning = false;
        function spindleOn() {
            if (!connected) return;
            cmd('M3 S' + lastSpindleSpeed);
            spindleRunning = true;
            updateSpindleButton();
        }

        function spindleOff() {
            if (!connected) return;
            cmd('M5');
            spindleRunning = false;
            updateSpindleButton();
        }

        function setSpindleSpeed(rpm) {
            if (!connected) return;
            lastSpindleSpeed = rpm;
            if (spindleRunning) {
                cmd('S' + rpm);
            }
        }

        function updateSpindleButton() {
            const btn = document.getElementById('spindleOnBtn');
            if (spindleRunning) {
                btn.classList.remove('spindle-off');
                btn.classList.add('spindle-on');
            } else {
                btn.classList.remove('spindle-on');
                btn.classList.add('spindle-off');
            }
        }

        // ========== JOB CONTROL ==========
        function jobStart() {
            if (spindleWasRunning) {
                sendRealtime(0x9E); // Toggle spindle back on
                spindleWasRunning = false;
                setTimeout(() => {
                    wsSend({ type: 'cycle_start' });
                    wsSend({ type: 'file_resume' });
                    streamerPaused = false;
                }, 5000);
            } else if (lastMachineState.startsWith('HOLD')) {
                wsSend({ type: 'cycle_start' });
                if (streamerPaused) {
                    wsSend({ type: 'file_resume' });
                    streamerPaused = false;
                }
            } else {
                wsSend({ type: 'file_start' });
            }
        }

        function jobPause() {
            wsSend({ type: 'feed_hold' });
            wsSend({ type: 'file_pause' });
            streamerPaused = true;
            spindleWasRunning = true;
            sendRealtime(0x9E); // Spindle stop override
        }

        function jobStop() {
            wsSend({ type: 'file_stop' });
            sendRealtime(0x9E);
            spindleWasRunning = false;
            streamerPaused = false;
        }

        // ========== MACROS ==========
        function runMacro(name) {
            if (!connected) return;
            if (name === 'HOMING') {
                cmd('$H');
                return;
            }
            if (name === 'tool_change' && !setZDone) {
                alert('Run Set Z first!');
                return;
            }
            debugLog('=== MACRO: ' + name + ' ===', 'info');
            wsSend({ type: 'macro_run', name: name });
        }

        // ========== ZERO PROBES ==========
        let pendingProbe = '';

        function runProbe(name) {
            if (!connected) return;
            debugLog('=== PROBE: ' + name + ' ===', 'info');
            wsSend({ type: 'macro_run', name: name });
        }

        function showProbeModal(probeName) {
            if (!connected) return;
            pendingProbe = probeName;
            document.getElementById('probeModal').classList.add('open');
        }

        function closeProbeModal() {
            document.getElementById('probeModal').classList.remove('open');
            pendingProbe = '';
        }

        function runProbeWithDia(toolDiameter) {
            if (!pendingProbe) return;
            debugLog('=== PROBE: ' + pendingProbe + ' (tool=' + toolDiameter + 'mm) ===', 'info');
            wsSend({ type: 'macro_run', name: pendingProbe, tool_diameter: toolDiameter });
            closeProbeModal();
        }

        // ========== UNITS ==========
        let currentUnit = 'mm';
        const mmSteps = [0.025, 0.25, 2.5, 25];
        const inSteps = [0.001, 0.01, 0.1, 1];

        function toggleUnits() {
            if (currentUnit === 'mm') {
                currentUnit = 'in';
                cmd('G20');
            } else {
                currentUnit = 'mm';
                cmd('G21');
            }
            document.getElementById('unitWork').textContent = currentUnit;
            document.getElementById('unitMach').textContent = currentUnit;
            updateStepButtons();
        }

        function updateStepButtons() {
            const steps = currentUnit === 'mm' ? mmSteps : inSteps;
            const container = document.getElementById('stepButtons');
            document.getElementById('stepLabel').innerHTML =
                '<span style="color:#555">&lt;</span><span>Step (' + currentUnit + ')</span><span style="color:#555">&gt;</span>';
            container.innerHTML = '';
            steps.forEach((step) => {
                const btn = document.createElement('button');
                btn.className = 'step-btn';
                btn.textContent = step;
                btn.style.cssText = 'padding:4px 6px; font-size:10px;';
                btn.onclick = function() { setStep(step, this); };
                if ((currentUnit === 'mm' && step === 2.5) || (currentUnit === 'in' && step === 0.1)) {
                    btn.classList.add('active');
                    jogStep = step;
                }
                container.appendChild(btn);
            });
        }

        // ========== BUTTON STATES ==========
        function updateButtonStates() {
            const gcodeInput = document.getElementById('gcodeInput');

            if (!connected) {
                document.getElementById('btnRun').disabled = true;
                document.getElementById('btnPause').disabled = true;
                document.getElementById('btnStop').disabled = true;
                document.getElementById('btnUnlock').disabled = true;
                document.getElementById('btnReset').disabled = true;
                document.getElementById('btnHome').disabled = true;
                document.querySelectorAll('.goto-btn').forEach(btn => btn.disabled = true);
                document.querySelectorAll('button[onclick^="runMacro"]').forEach(btn => btn.disabled = true);
                document.querySelectorAll('button[onclick^="jog("], .xy-grid button, .step-btn').forEach(btn => btn.disabled = true);
                gcodeInput.disabled = true;
                return;
            }

            // During macro run, disable most controls except stop/reset
            if (macroRunning) {
                document.getElementById('btnRun').disabled = true;
                document.getElementById('btnPause').disabled = true;
                document.getElementById('btnStop').disabled = false;  // Allow stop
                document.getElementById('btnUnlock').disabled = true;
                document.getElementById('btnReset').disabled = false;  // Allow reset
                document.getElementById('btnHome').disabled = true;
                document.querySelectorAll('.goto-btn').forEach(btn => btn.disabled = true);
                document.querySelectorAll('button[onclick^="runMacro"]').forEach(btn => btn.disabled = true);
                document.querySelectorAll('button[onclick^="jog("], .xy-grid button, .step-btn').forEach(btn => btn.disabled = true);
                gcodeInput.disabled = true;
                return;
            }

            const state = lastMachineState;
            document.getElementById('btnRun').disabled = !state.startsWith('HOLD');
            document.getElementById('btnPause').disabled = !(state === 'IDLE' || state === 'RUN');
            document.getElementById('btnStop').disabled = !(state === 'RUN' || streamerPaused || macroRunning);
            document.getElementById('btnUnlock').disabled = !(state === 'ALARM');
            document.getElementById('btnReset').disabled = false;
            document.getElementById('btnHome').disabled = !(state === 'IDLE');

            const jogEnabled = (state === 'IDLE');
            document.querySelectorAll('.goto-btn').forEach(btn => btn.disabled = !jogEnabled);
            document.querySelectorAll('button[onclick^="runMacro"]').forEach(btn => {
                if (!btn.id || btn.id !== 'btnHome') btn.disabled = !jogEnabled;
            });
            document.querySelectorAll('button[onclick^="jog("], .xy-grid button, .step-btn').forEach(btn => btn.disabled = !jogEnabled);
            gcodeInput.disabled = !jogEnabled;
        }

        // ========== DIALOGS ==========
        let confirmCb = null;
        function showConfirm(msg, cb) {
            document.getElementById('confirmMsg').textContent = msg;
            document.getElementById('confirmModal').classList.add('open');
            confirmCb = cb;
        }
        function confirmResolve(yes) {
            document.getElementById('confirmModal').classList.remove('open');
            if (confirmCb) confirmCb(yes);
            confirmCb = null;
        }

        function homeA() {
            if (!connected) return;
            showConfirm('Unplug A axis stepper, then click Yes', (yes) => {
                if (!yes) return;
                cmd('$113=1000000');
                cmd('$123=1000000');
                cmd('G91');
                cmd('G0 A-40000');
                cmd('G90');
                setTimeout(() => {
                    showConfirm('Plug A axis stepper back in, then click Yes', (yes2) => {
                        if (!yes2) return;
                        cmd('$113=50');
                        cmd('$123=20');
                        cmd('G10 L20 P1 A0');
                        debugLog('Home A complete: machine A reset, work A zeroed', 'info');
                    });
                }, 5000);
            });
        }

        function hideContinue() {
            document.getElementById('continueOverlay').style.display = 'none';
        }

        // ========== WORK COORDINATE MODAL ==========
        let currentWorkCoords = { x: 0, y: 0, z: 0, a: 0 };

        function openWorkModal() {
            const x = parseFloat(document.getElementById('workX').textContent) || 0;
            const y = parseFloat(document.getElementById('workY').textContent) || 0;
            const z = parseFloat(document.getElementById('workZ').textContent) || 0;
            const a = parseFloat(document.getElementById('workA').textContent) || 0;
            currentWorkCoords = { x, y, z, a };
            document.getElementById('modalX').value = x.toFixed(3);
            document.getElementById('modalY').value = y.toFixed(3);
            document.getElementById('modalZ').value = z.toFixed(3);
            document.getElementById('modalA').value = a.toFixed(3);
            document.getElementById('workModal').classList.add('open');
            document.getElementById('modalX').focus();
        }

        function closeWorkModal() {
            document.getElementById('workModal').classList.remove('open');
        }

        function applyWorkCoords() {
            const newX = parseFloat(document.getElementById('modalX').value);
            const newY = parseFloat(document.getElementById('modalY').value);
            const newZ = parseFloat(document.getElementById('modalZ').value);
            const newA = parseFloat(document.getElementById('modalA').value);

            const xChanged = Math.abs(newX - currentWorkCoords.x) > 0.0001;
            const yChanged = Math.abs(newY - currentWorkCoords.y) > 0.0001;
            const zChanged = Math.abs(newZ - currentWorkCoords.z) > 0.0001;
            const aChanged = Math.abs(newA - currentWorkCoords.a) > 0.0001;

            let parts = [];
            if (xChanged) parts.push('X' + newX.toFixed(3));
            if (yChanged) parts.push('Y' + newY.toFixed(3));
            if (zChanged) parts.push('Z' + newZ.toFixed(3));
            if (aChanged) parts.push('A' + newA.toFixed(3));
            if (parts.length > 0) {
                cmd('G10 L20 P1 ' + parts.join(' '));
                // If Z was changed, run SetZ macro after a delay
                if (zChanged) {
                    setTimeout(() => runMacro('set_z'), 500);
                }
            }

            closeWorkModal();
        }

        function zeroZAndSetZ() {
            cmd('G10 L20 P1 Z0');
            setTimeout(() => runMacro('set_z'), 500);
        }

        // ========== DEBUG CONSOLE ==========
        function debugLog(msg, type) {
            type = type || '';
            const log = document.getElementById('debugLog');
            const line = document.createElement('div');
            line.className = 'debug-line' + (type ? ' ' + type : '');
            line.textContent = new Date().toLocaleTimeString() + ' ' + msg;
            log.appendChild(line);
            while (log.children.length > 200) {
                log.removeChild(log.firstChild);
            }
            const content = document.getElementById('debugContent');
            content.scrollTop = content.scrollHeight;
        }

        function toggleDebug() {
            const content = document.getElementById('debugContent');
            const toggle = document.getElementById('debugToggle');
            content.classList.toggle('open');
            toggle.textContent = content.classList.contains('open') ? '\u25B2' : '\u25BC';
        }

        function toggleStatusLog() {
            showStatusLog = !showStatusLog;
            const btn = document.getElementById('statusToggle');
            btn.style.background = showStatusLog ? '#2a4a2a' : '#4a2a2a';
        }

        function copyDebugLog(e) {
            e.stopPropagation();
            const log = document.getElementById('debugLog');
            const text = Array.from(log.children).map(el => el.textContent).join('\n');
            const btn = e.target;
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    btn.textContent = 'Copied!';
                    setTimeout(() => btn.textContent = 'Copy', 1500);
                }).catch(() => copyFallback(text, btn));
            } else {
                copyFallback(text, btn);
            }
        }

        function copyFallback(text, btn) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy', 1500);
            } catch (err) {
                btn.textContent = 'Failed';
                setTimeout(() => btn.textContent = 'Copy', 1500);
            }
            document.body.removeChild(textarea);
        }

        // ========== KEYBOARD SHORTCUTS ==========
        function cycleStep(direction) {
            const steps = currentUnit === 'mm' ? mmSteps : inSteps;
            const currentIndex = steps.indexOf(jogStep);
            const newIndex = Math.max(0, Math.min(steps.length - 1, currentIndex + direction));
            if (newIndex !== currentIndex) {
                jogStep = steps[newIndex];
                document.querySelectorAll('.step-btn').forEach((btn, i) => {
                    btn.classList.toggle('active', i === newIndex);
                });
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            if (e.key === '>' || e.key === '.') { e.preventDefault(); cycleStep(1); return; }
            if (e.key === '<' || e.key === ',') { e.preventDefault(); cycleStep(-1); return; }
            if (e.key === 'ArrowUp') { e.preventDefault(); jog('Y', 1); return; }
            if (e.key === 'ArrowDown') { e.preventDefault(); jog('Y', -1); return; }
            if (e.key === 'ArrowLeft') { e.preventDefault(); jog('X', -1); return; }
            if (e.key === 'ArrowRight') { e.preventDefault(); jog('X', 1); return; }
            if (e.key === 'PageUp') { e.preventDefault(); jog('Z', 1); return; }
            if (e.key === 'PageDown') { e.preventDefault(); jog('Z', -1); return; }
            if (e.key === 'Home') { e.preventDefault(); jog('A', -1); return; }
            if (e.key === 'End') { e.preventDefault(); jog('A', 1); return; }
        });

        // ========== CAMERA ==========
        function setupCamera() {
            const cam = document.getElementById('camera');
            const img = document.createElement('img');
            img.src = CAMERA_URL;
            img.onerror = () => { cam.innerHTML = '<span>Camera unavailable</span>'; };
            img.onload = () => { cam.innerHTML = ''; cam.appendChild(img); };
        }

        // ========== INIT ==========
        connect();
        setupCamera();
        updateStepButtons();
        updateButtonStates();
    </script>
</body>
</html>
