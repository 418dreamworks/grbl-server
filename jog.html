<!DOCTYPE html>
<html>
<head>
    <title>CNC Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace;
            background: #1a1a1a;
            color: #fff;
            margin: 0;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 20px;
        }
        h2 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #888;
            text-transform: uppercase;
            text-align: center;
        }
        .section { margin-bottom: 20px; }
        .row { display: flex; gap: 8px; margin-bottom: 8px; }
        button {
            background: #333;
            border: 1px solid #555;
            color: #fff;
            padding: 12px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            min-width: 70px;
        }
        button:hover { background: #444; }
        button:active { background: #0066cc; }
        button .key { display: block; font-size: 10px; color: #666; margin-top: 4px; }

        /* Color coding */
        .machine-ctrl button { background: #3a3a3a; border-color: #5a5a5a; }
        .z-buttons button, .work-zero button, .xy-grid button { flex: 1; min-height: 65px; }
        .z-buttons button { background: #2a4a2a; border-color: #3a6a3a; }
        .work-zero button { background: #4a2a2a; border-color: #6a3a3a; }
        .xy-grid button { background: #2a2a4a; border-color: #3a3a6a; padding: 15px; }
        .xy-grid button.work-zero { background: #4a2a2a; border-color: #6a3a3a; }
        .tool-buttons button { background: #4a4a2a; border-color: #6a6a3a; }
        .job-ctrl button { background: #2a4a4a; border-color: #3a6a6a; }
        .job-ctrl button.stop { background: #6a2a2a; border-color: #8a3a3a; }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .xy-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .jog-grid { display: grid; grid-template-columns: repeat(4, auto); gap: 8px; }
        .jog-grid button { padding: 12px 20px; font-size: 14px; }
        .step-selector .step-label, .spindle-ctrl .step-label { font-size: 12px; color: #888; margin-bottom: 4px; text-align: center; }
        .step-selector .step-btn { padding: 6px 10px; font-size: 12px; flex: 1; text-align: center; }
        .step-selector .step-btn.active { background: #4a6a4a; border-color: #6a8a6a; }
        .spindle-on { background: #2a4a2a !important; border-color: #3a6a3a !important; }
        .spindle-off { background: #4a2a2a !important; border-color: #6a3a3a !important; }
        .spindle-speed-btn { padding: 2px 8px !important; min-width: 30px !important; font-size: 10px !important; }

        .pos {
            font-family: monospace;
            font-size: 16px;
            padding: 15px;
            background: #222;
            border-radius: 4px;
            grid-column: 1 / -1;
            position: relative;
        }
        .pos > div > div:first-child > span { margin-right: 8px; }
        .pos .label { color: #666; }
        .zero-btn {
            padding: 2px 0;
            width: 28px;
            min-width: 28px;
            max-width: 28px;
            font-size: 11px;
            margin-left: 2px;
            background: #3a3a3a;
            border-color: #555;
            text-align: center;
            box-sizing: border-box;
        }
        .zero-btn:hover { background: #4a4a4a; }

        .left-col { display: flex; flex-direction: column; justify-content: space-between; }
        .right-col { display: flex; flex-direction: column; }

        .camera {
            width: 100%;
            aspect-ratio: 4/3;
            background: #111;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #444;
        }
        .camera img { width: 100%; height: 100%; object-fit: contain; }

        .debug-console {
            grid-column: 1 / -1;
            background: #111;
            border: 1px solid #333;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #222;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
        }
        .debug-header:hover { background: #2a2a2a; }
        .debug-content {
            height: 150px;
            overflow-y: auto;
            padding: 8px 12px;
            display: none;
        }
        .debug-content.open { display: block; }
        .debug-line { color: #0f0; margin: 2px 0; white-space: pre-wrap; word-break: break-all; }
        .debug-line.sent { color: #ff0; }
        .debug-line.error { color: #f55; }
        .debug-line.info { color: #5af; }

        .status-bar {
            grid-column: 1 / -1;
            background: #222;
            border-radius: 4px;
            padding: 12px 15px;
        }
        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .machine-state {
            font-weight: bold;
            font-size: 14px;
            padding: 4px 12px;
            border-radius: 3px;
            background: #4a2a2a;
        }
        .machine-state.idle { background: #2a4a2a; }
        .machine-state.run { background: #2a4a4a; }
        .machine-state.hold { background: #4a4a2a; }
        .machine-state.alarm { background: #6a2a2a; }
        .machine-state.disconnected { background: #4a2a2a; }
        .file-name { color: #888; font-size: 13px; }
        .progress { font-family: monospace; color: #888; }
        .progress-bar {
            height: 4px;
            background: transparent;
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            background: #4a9a4a;
            transition: width 0.3s;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            min-width: 300px;
        }
        .modal h3 { margin: 0 0 15px 0; font-size: 16px; }
        .modal-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        .modal-row label { width: 30px; color: #888; }
        .modal-row input {
            flex: 1;
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #fff;
            font-family: monospace;
            font-size: 14px;
        }
        .modal-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .modal-buttons button { flex: 1; }
        .pos .label.clickable { cursor: pointer; text-decoration: underline; }
        .pos .label.clickable:hover { color: #aaa; }
        .unit { color: #888; margin-left: 10px; }
        .unit.clickable { cursor: pointer; text-decoration: underline; }
        .unit.clickable:hover { color: #aaa; }
        .pos-buttons button {
            padding: 6px 10px;
            font-size: 12px;
            min-width: auto;
        }
        .pos-buttons button .key {
            margin-top: 2px;
        }

        /* New: Port selector */
        .port-select {
            background: #1a1a1a;
            color: #fff;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 13px;
            font-family: monospace;
        }

        /* New: File controls */
        .file-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .file-controls button {
            padding: 4px 10px;
            font-size: 12px;
            min-width: auto;
        }

        /* New: Recovery info */
        .recovery-info {
            color: #6a6;
            font-size: 12px;
            font-family: monospace;
        }

        /* Console + Status Panel wrapper */
        .console-wrapper {
            grid-column: 1 / -1;
            display: flex;
            gap: 8px;
        }
        .console-wrapper .debug-console {
            flex: 3;
            grid-column: auto;
        }
        .status-panel {
            flex: 1;
            background: #111;
            border: 1px solid #333;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            padding: 8px;
            min-width: 200px;
        }
        .status-panel h4 {
            margin: 0 0 8px 0;
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
        }
        .status-panel .row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        .status-panel .label { color: #666; }
        .status-panel .value { color: #0f0; }
        .status-panel .section { margin-bottom: 12px; }
    </style>
</head>
<body>
    <!-- Status Bar (full width) -->
    <div class="status-bar">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <!-- Left column: info rows stacked -->
            <div style="display: flex; flex-direction: column; gap: 4px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="font-size: 11px; color: #666; font-family: monospace;">v1.055</span>
                    <span class="machine-state" id="machineState">DISCONNECTED</span>
                    <!-- Port selector -->
                    <select id="portSelect" class="port-select" onchange="changePort(this.value)">
                        <option value="">Select port...</option>
                    </select>
                    <!-- File info / Load button -->
                    <input type="file" id="fileInput" accept=".nc,.gcode,.ngc,.tap" style="display:none" onchange="handleFileSelect(event)">
                    <span class="file-name" id="fileName" onclick="document.getElementById('fileInput').click()" style="cursor:pointer; text-decoration: underline dotted;" title="Click to load file">Load File</span>
                    <!-- File stats (feed/plunge/spindle) -->
                    <span id="fileStats" style="font-size: 11px; color: #888; font-family: monospace;"></span>
                    <!-- Bounds warning -->
                    <span id="boundsWarning" style="font-size: 11px; color: #f55; font-family: monospace; font-weight: bold;"></span>
                </div>
                <!-- Second row: Job progress info -->
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span id="jobProgress" style="font-size: 11px; color: #aaa; font-family: monospace; border: 1px solid #444; padding: 2px 8px; border-radius: 3px; background: #222;">
                        <span id="lineProgress">--/--</span>
                        <span style="color: #666; margin: 0 6px;">|</span>
                        <span id="timeRemaining" style="color: #6af;">--:--</span>
                        <span style="color: #666; margin: 0 6px;">|</span>
                        <span id="timeToTC" style="color: #f90;">--:-- to M6</span>
                    </span>
                </div>
            </div>
            <!-- Right column: buttons centered -->
            <div class="btn-container" style="display: flex; flex-direction: column; justify-content: center; gap: 4px; width: 468px;">
                <div id="currentLine" style="display:none;">--</div>
                <div style="display: flex; gap: 16px;">
                <div class="job-ctrl" style="display: flex; gap: 8px; width: 50%;">
                    <button id="btnRun" style="flex: 1; background: #2a4a2a; border-color: #3a6a3a;" onclick="jobStart()">Run</button>
                    <button id="btnPause" style="flex: 1; background: #4a4a2a; border-color: #6a6a3a;" onclick="jobPause()">Pause</button>
                    <button id="btnStop" style="flex: 1; background: #4a2a2a; border-color: #6a3a3a;" onclick="jobStop()">Stop</button>
                </div>
                <div class="machine-ctrl" style="display: flex; gap: 8px; width: 50%;">
                    <button id="btnUnlock" style="flex: 1;" onclick="unlock()">Unlock</button>
                    <button id="btnReset" style="flex: 1;" onclick="doReset()">Reset</button>
                    <button id="btnHome" style="flex: 1;" onclick="runMacro('HOMING')">Home</button>
                </div>
                </div>
            </div>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    </div>

    <!-- Position Display (full width) -->
    <div class="pos">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
            <div style="display: flex; align-items: center; min-width: 520px;">
                <span class="label clickable" onclick="openWorkModal()" style="display:inline-block;width:40px;">Work:</span>
                <span><span style="color: #fc0; cursor:pointer;" onclick="cmd('$HX')" title="Home X">X:</span> <span id="workX" style="display:inline-block;width:8ch;text-align:right;">---.---</span><button class="zero-btn" onclick="cmd('G10 L20 P1 X0')">&#x2299;0</button></span>
                <span><span style="color: #fc0; cursor:pointer;" onclick="cmd('$HY')" title="Home Y">Y:</span> <span id="workY" style="display:inline-block;width:8ch;text-align:right;">---.---</span><button class="zero-btn" onclick="cmd('G10 L20 P1 Y0')">&#x2299;0</button></span>
                <span><span style="color: #fc0; cursor:pointer;" onclick="cmd('$HZ')" title="Home Z">Z:</span> <span id="workZ" style="display:inline-block;width:8ch;text-align:right;">---.---</span><button class="zero-btn" onclick="zeroZAndSetZ()">&#x2299;0</button></span>
                <span><span style="color: #fc0; cursor:pointer;" onclick="homeA()" title="Home A">A:</span> <span id="workA" style="display:inline-block;width:8ch;text-align:right;">---.---</span><button class="zero-btn" onclick="cmd('G10 L20 P1 A0')">&#x2299;0</button></span>
                <span class="unit clickable" onclick="toggleUnits()" id="unitDisplay" style="margin-left: 15px; position: relative; top: 14px;">mm</span>
            </div>
            <span id="spindleRPM" onclick="spindleOn()" style="font-size: 20px; font-weight: bold; white-space: nowrap; font-family: monospace; display:inline-block; width:12ch; cursor: pointer;" title="Click to start spindle at S12000"><span id="spindleRPMValue" style="display:inline-block;width:5ch;text-align:right;">--</span><span id="spindleRPMUnit" style="display:inline-block;width:7ch;text-align:left;padding-left:1ch;">RPM</span></span>
            <div style="display: flex; gap: 2px; align-items: center;">
                <button onclick="spindleOverride(-10)" style="min-width: auto; padding: 4px 6px; font-size: 15px;">-10%</button>
                <button onclick="spindleOverride(-1)" style="min-width: auto; padding: 4px 6px; font-size: 15px;">-1%</button>
                <span id="spindleOverride" onclick="spindleResetOverride()" style="font-family: monospace; width: 5ch; display: inline-block; text-align: center; font-size: 15px; font-weight: bold; background: #222; padding: 4px 4px; border-radius: 4px; cursor: pointer;" title="Click to reset to 100%">100%</span>
                <button onclick="spindleOverride(1)" style="min-width: auto; padding: 4px 6px; font-size: 15px;">+1%</button>
                <button onclick="spindleOverride(10)" style="min-width: auto; padding: 4px 6px; font-size: 15px;">+10%</button>
                <button onclick="spindleOff()" style="min-width: auto; padding: 4px 8px; font-size: 13px; background: #4a2a2a; border-color: #6a3a3a;">OFF</button>
            </div>
        </div>
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; color: #444; min-width: 520px;">
                <span class="label" style="display:inline-block;width:40px;">Mach:</span>
                <span><span style="color: #553;">X:</span> <span id="machX" style="display:inline-block;width:8ch;text-align:right;">---.---</span><button class="zero-btn goto-btn" onclick="cmd('$HX')">&#x2192;0</button></span>
                <span><span style="color: #553;">Y:</span> <span id="machY" style="display:inline-block;width:8ch;text-align:right;">---.---</span><button class="zero-btn goto-btn" onclick="cmd('$HY')">&#x2192;0</button></span>
                <span><span style="color: #553;">Z:</span> <span id="machZ" style="display:inline-block;width:8ch;text-align:right;">---.---</span><button class="zero-btn goto-btn" onclick="cmd('$HZ')">&#x2192;0</button></span>
                <span><span style="color: #553;">A:</span> <span id="machA" style="display:inline-block;width:8ch;text-align:right;">---.---</span><button class="zero-btn goto-btn" onclick="homeA()">&#x2192;0</button></span>
            </div>
            <span id="machineSpeed" style="font-size: 20px; font-weight: bold; white-space: nowrap; font-family: monospace; display:inline-block; width:12ch;"><span id="machineSpeedValue" style="display:inline-block;width:5ch;text-align:right;">0</span><span id="machineSpeedUnit" style="display:inline-block;width:7ch;text-align:left;padding-left:1ch;">mm/min</span></span>
            <div style="display: flex; gap: 2px; align-items: center;">
                <button onclick="feedOverride(-10)" style="min-width: auto; padding: 4px 6px; font-size: 15px;">-10%</button>
                <button onclick="feedOverride(-1)" style="min-width: auto; padding: 4px 6px; font-size: 15px;">-1%</button>
                <span id="feedRate" onclick="feedOverride(0)" style="font-family: monospace; width: 5ch; display: inline-block; text-align: center; font-size: 15px; font-weight: bold; background: #222; padding: 4px 4px; border-radius: 4px; cursor: pointer;" title="Click to reset to 100%">100%</span>
                <button onclick="feedOverride(1)" style="min-width: auto; padding: 4px 6px; font-size: 15px;">+1%</button>
                <button onclick="feedOverride(10)" style="min-width: auto; padding: 4px 6px; font-size: 15px;">+10%</button>
            </div>
        </div>
    </div>

    <!-- Left Column -->
    <div class="left-col">
        <div class="section">
            <div class="xy-grid">
                <button onclick="gotoXY(workMaxX-MARGIN, MARGIN)">&#x2196;</button>
                <button onclick="gotoXY(workMaxX/2, MARGIN)">&#x2191;</button>
                <button onclick="gotoXY(MARGIN, MARGIN)">&#x2197;</button>
                <button onclick="gotoXY(workMaxX-MARGIN, workMaxY/2)">&#x2190;</button>
                <button onclick="gotoXY(workMaxX/2, workMaxY/2)">&#x25CF;</button>
                <button onclick="gotoXY(MARGIN, workMaxY/2)">&#x2192;</button>
                <button onclick="gotoXY(workMaxX-MARGIN, workMaxY-MARGIN)">&#x2199;</button>
                <button onclick="gotoXY(workMaxX/2, workMaxY-MARGIN)">&#x2193;</button>
                <button onclick="gotoXY(MARGIN, workMaxY-MARGIN)">&#x2198;</button>
            </div>
            <div class="xy-grid" style="margin-top: 8px;">
                <button style="background:#4a2a2a; border-color:#6a3a3a;" onclick="cmd('G54 G0 X0 Y0')">X0 Y0</button>
                <button style="background:#4a2a2a; border-color:#6a3a3a;" onclick="cmd('G54 G0 Z0')">Z0</button>
                <button style="background:#4a2a2a; border-color:#6a3a3a;" onclick="cmd('G54 G0 Z10')">Z10</button>
            </div>
        </div>
        <div class="section" style="margin-top: 8px; flex: 1; display: flex; flex-direction: column;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; flex: 1;">
                <button onclick="jog('X', 1)" style="font-size:11px; min-width:0; min-height:0;">X+<span class="key">[&#x2192;]</span></button>
                <button onclick="jog('Y', 1)" style="font-size:11px; min-width:0; min-height:0;">Y+<span class="key">[&#x2191;]</span></button>
                <button onclick="jog('Z', 1)" style="font-size:11px; min-width:0; min-height:0;">Z+<span class="key">[Fn&#x2191;]</span></button>
                <button onclick="jog('A', 1)" style="font-size:11px; min-width:0; min-height:0;">A+<span class="key">[Fn&#x2192;]</span></button>
                <button onclick="jog('X', -1)" style="font-size:11px; min-width:0; min-height:0;">X-<span class="key">[&#x2190;]</span></button>
                <button onclick="jog('Y', -1)" style="font-size:11px; min-width:0; min-height:0;">Y-<span class="key">[&#x2193;]</span></button>
                <button onclick="jog('Z', -1)" style="font-size:11px; min-width:0; min-height:0;">Z-<span class="key">[Fn&#x2193;]</span></button>
                <button onclick="jog('A', -1)" style="font-size:11px; min-width:0; min-height:0;">A-<span class="key">[Fn&#x2190;]</span></button>
            </div>
            <div class="step-selector" style="margin-top: 4px;">
                <div class="step-label" id="stepLabel" style="display:flex;justify-content:space-between;font-size:10px;"><span style="color:#555">&lt;</span><span>Step (mm)</span><span style="color:#555">&gt;</span></div>
                <div id="stepButtons" style="display: flex; gap: 3px;">
                    <button class="step-btn" onclick="setStep(0.025, this)" style="padding:4px 6px; font-size:10px;">0.025</button>
                    <button class="step-btn" onclick="setStep(0.25, this)" style="padding:4px 6px; font-size:10px;">0.25</button>
                    <button class="step-btn active" onclick="setStep(2.5, this)" style="padding:4px 6px; font-size:10px;">2.5</button>
                    <button class="step-btn" onclick="setStep(25, this)" style="padding:4px 6px; font-size:10px;">25</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Middle Column -->
    <div class="mid-col">
        <div class="section">
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <!-- Macros -->
                <div class="tool-buttons" style="display: flex; gap: 8px;">
                    <button style="flex: 1;" onclick="runMacro('tool_change')">Tool Change</button>
                </div>
                <!-- Zero Probes -->
                <div class="tool-buttons" style="display: flex; gap: 8px;">
                    <button style="flex: 1; background: #2a3a4a; border-color: #3a5a7a;" onclick="runProbe('probe_z')">Z</button>
                    <button style="flex: 1; background: #2a3a4a; border-color: #3a5a7a;" onclick="showProbeModal('probe_x')">X</button>
                    <button style="flex: 1; background: #2a3a4a; border-color: #3a5a7a;" onclick="showProbeModal('probe_y')">Y</button>
                    <button style="flex: 1; background: #2a3a4a; border-color: #3a5a7a;" onclick="showProbeModal('probe_xy')">XY</button>
                    <button style="flex: 1; background: #2a3a4a; border-color: #3a5a7a;" onclick="showProbeModal('probe_xyz')">XYZ</button>
                </div>
                <!-- Status -->
                <div>
                    <button id="debugInfo" style="width: 100%; padding: 12px; background: #3a3a3a; border-color: #555;">&#x2713; Synced</button>
                </div>
                <!-- Debug spindle test -->
                <div>
                    <button id="debugSpindleBtn" onclick="debugSpindleTest()" style="width: 100%; padding: 12px; background: #4a2a2a; border-color: #7a3a3a; font-size: 12px; text-align: left; font-family: monospace; white-space: pre; line-height: 1.4;">Debug Spindle
1. M3 S10000 (wait 10s)
2. -10% override
3. G1 Z-1 F10 (6s move)
4. -10% override</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column - Camera/G-code Toggle -->
    <div class="right-col">
        <div style="display: flex; gap: 4px; margin-bottom: 8px;">
            <button id="btnViewCamera" onclick="showView('camera')" style="flex: 1; padding: 6px; font-size: 12px; background: #2a4a2a; border-color: #3a6a3a;">Camera</button>
            <button id="btnViewGcode" onclick="showView('gcode')" style="flex: 1; padding: 6px; font-size: 12px;">G-code</button>
        </div>
        <div class="section" style="flex: 1; position: relative;">
            <div class="camera" id="camera" style="height: 100%;">
                <span>No camera feed</span>
            </div>
            <div id="gcodeViewer" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #111; border-radius: 4px; overflow-y: auto; font-family: monospace; font-size: 12px; padding: 8px;">
            </div>
        </div>
    </div>

    <!-- Console + Status Panel -->
    <div class="console-wrapper">
        <div class="debug-console">
            <div class="debug-header">
                <span onclick="toggleDebug()" style="cursor:pointer;">Console</span>
                <input type="text" id="gcodeInput" placeholder="G-code..."
                       style="flex: 1; margin: 0 8px; padding: 4px 8px; background: #222; border: 1px solid #444;
                              border-radius: 4px; color: #fff; font-family: monospace; font-size: 12px;"
                       onkeydown="if(event.key==='Enter'){sendGcodeInput();event.preventDefault();}">
                <button onclick="sendGcodeInput()" style="padding: 4px 12px; font-size: 11px; margin-right: 8px;">Send</button>
                <button onclick="copyDebugLog(event)" style="padding:2px 8px;font-size:11px;margin-right:4px;">Copy</button>
                <span id="debugToggle" onclick="toggleDebug()" style="cursor:pointer;">&#x25B2;</span>
            </div>
            <div class="debug-content open" id="debugContent">
                <div id="debugLog"></div>
            </div>
        </div>
        <div class="status-panel">
            <div class="section">
                <h4>Controller Status</h4>
                <div class="row"><span class="label">State:</span><span class="value" id="spState">--</span></div>
            </div>
            <div class="section">
                <h4>Overrides (Ov:)</h4>
                <div class="row"><span class="label">Feed:</span><span class="value" id="spFeedOv">--</span></div>
                <div class="row"><span class="label">Rapid:</span><span class="value" id="spRapidOv">--</span></div>
                <div class="row"><span class="label">Spindle:</span><span class="value" id="spSpindleOv">--</span></div>
            </div>
            <div class="section">
                <h4>Actual (FS:)</h4>
                <div class="row"><span class="label">Feed:</span><span class="value" id="spFeed">-- mm/min</span></div>
                <div class="row"><span class="label">Spindle:</span><span class="value" id="spSpindle">-- RPM</span></div>
            </div>
            <div class="section">
                <h4>Last Raw Status</h4>
                <div id="spRaw" style="font-size:10px; color:#666; word-break:break-all;">--</div>
            </div>
        </div>
    </div>

    <!-- M0 Continue Overlay -->
    <div id="continueOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); z-index:1000; align-items:center; justify-content:center;" onclick="if(event.target===this)hideContinue()">
        <button onclick="macroContinue(); hideContinue();" style="padding: 80px 160px; font-size: 72px; font-weight: bold; background: #2a6a2a; border: 6px solid #4a9a4a; color: #fff; border-radius: 24px; cursor: pointer; box-shadow: 0 0 60px rgba(0,255,0,0.3); text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
            CONTINUE<br><span style="font-size: 24px; color: #aaa;">Swap tool, then press to resume</span>
        </button>
    </div>

    <!-- Start Job Dialog (shown after file load) -->
    <div class="modal" id="startJobModal" onclick="if(event.target===this)closeStartJobModal()">
        <div class="modal-content" style="min-width: 350px;">
            <h3 style="margin-bottom: 16px;">Start Job</h3>
            <div style="margin-bottom: 12px; color: #888; font-size: 12px;">
                Before starting, verify:<br>
                - Tool is at safe position<br>
                - Work zero is set correctly<br>
                - If resuming, check Z height at that line
            </div>
            <div style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 4px;">Start from line:</label>
                <input type="number" id="startLine" value="1" min="1" style="width: 100px; padding: 6px; background: #222; border: 1px solid #444; border-radius: 4px; color: #fff; font-family: monospace;">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="cursor: pointer; display: block; margin-bottom: 8px;">
                    <input type="checkbox" id="spindleFirst" style="margin-right: 8px;" onchange="updateSpindleSpeedDisplay()">
                    Turn on spindle first
                </label>
                <div id="spindleSpeedSelector" style="display: none; margin-left: 24px;">
                    <button onclick="adjustStartSpindle(-1000)" style="padding: 4px 8px; font-size: 14px;">-</button>
                    <span id="startSpindleSpeed" style="display: inline-block; width: 60px; text-align: center; font-family: monospace; font-weight: bold;">12000</span>
                    <button onclick="adjustStartSpindle(1000)" style="padding: 4px 8px; font-size: 14px;">+</button>
                    <span style="color: #888; margin-left: 4px;">RPM</span>
                </div>
            </div>
            <div class="modal-buttons">
                <button onclick="closeStartJobModal()" style="background:#4a2a2a;">Cancel</button>
                <button onclick="startJobFromModal()" style="background:#2a4a2a;">Start</button>
            </div>
        </div>
    </div>

    <!-- Confirm Dialog -->
    <div class="modal" id="confirmModal" onclick="if(event.target===this)confirmResolve(false)">
        <div class="modal-content" style="min-width: 300px; text-align: center;">
            <h3 id="confirmMsg">Confirm</h3>
            <div class="modal-buttons">
                <button onclick="confirmResolve(false)" style="background:#4a2a2a;">No</button>
                <button onclick="confirmResolve(true)" style="background:#2a4a2a;">Yes</button>
            </div>
        </div>
    </div>

    <!-- Work Coordinate Modal -->
    <div class="modal" id="workModal" onclick="if(event.target===this)closeWorkModal()">
        <div class="modal-content">
            <h3>Set Work Coordinates</h3>
            <div class="modal-row">
                <label>X</label>
                <input type="number" id="modalX" step="0.001">
            </div>
            <div class="modal-row">
                <label>Y</label>
                <input type="number" id="modalY" step="0.001">
            </div>
            <div class="modal-row">
                <label>Z</label>
                <input type="number" id="modalZ" step="0.001">
            </div>
            <div class="modal-row">
                <label>A</label>
                <input type="number" id="modalA" step="0.001">
            </div>
            <div class="modal-buttons">
                <button onclick="closeWorkModal()">Cancel</button>
                <button onclick="applyWorkCoords()" style="background:#2a4a2a;">Apply</button>
            </div>
        </div>
    </div>

    <!-- Probe Tool Diameter Modal -->
    <div class="modal" id="probeModal" onclick="if(event.target===this)closeProbeModal()">
        <div class="modal-content" style="min-width: 280px;">
            <h3>Select Tool Diameter</h3>
            <div style="display: flex; flex-direction: column; gap: 12px; margin: 15px 0;">
                <button onclick="runProbeWithDia(6.35)" style="padding: 15px; font-size: 16px; background: #2a4a2a; border-color: #3a6a3a;">
                    1/4" (6.35mm)
                </button>
                <button onclick="runProbeWithDia(3.175)" style="padding: 15px; font-size: 16px; background: #2a4a4a; border-color: #3a6a6a;">
                    1/8" (3.175mm)
                </button>
            </div>
            <div class="modal-buttons">
                <button onclick="closeProbeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION ==========
        const CAMERA_URL = 'http://192.168.68.105:8080/?action=stream';

        // GRBL settings (populated from server)
        let workMaxX = 400, workMaxY = 400, workMaxZ = 100, workMaxA = 99999;
        const MARGIN = 2;
        let spindleMaxRPM = 24000, spindleMinRPM = 9000;

        // Machine state
        let machPosX = 0, machPosY = 0, machPosZ = 0, machPosA = 0;
        let pendingX = 0, pendingY = 0, pendingZ = 0, pendingA = 0;
        let lastMachineState = '';
        let pendingInitialized = false;
        let connected = false;
        let currentPort = '';
        let setZDone = false;
        let spindleWasRunning = false;
        let lastSpindleSpeed = 15000;
        let currentFeedRate = 0;
        let streamerPaused = false;
        let fileLoaded = false;
        let lastSafeLine = null;
        let lastSafeGcode = '';
        let showStatusLog = false;  // Hide status spam by default, toggle with button
        let macroRunning = false;

        // Tool change time estimation
        let toolChangeLines = [];
        let timeToNextTC = [];  // Precomputed time remaining to next tool change for each line
        let totalFileTime = 0;

        // G-code bounds (work coordinates from file analysis)
        let gcodeBounds = null;  // {min_x, max_x, min_y, max_y, min_z, max_z}
        // Work Coordinate Offset (machine pos when work = 0)
        let wcoX = 0, wcoY = 0, wcoZ = 0;

        // ========== WEBSOCKET CONNECTION ==========
        let ws;

        function getWsUrl() {
            // When served by the Python server, connect to same host
            // For local development, this won't connect (no server) but UI still works
            return 'ws://' + window.location.host + '/ws';
        }

        function connect() {
            try {
                ws = new WebSocket(getWsUrl());
            } catch (e) {
                debugLog('WebSocket not available (local preview mode)', 'info');
                return;
            }

            ws.onopen = () => {
                debugLog('WebSocket connected', 'info');
                connected = true;
                document.getElementById('machineState').textContent = 'CONNECTED';
                document.getElementById('machineState').className = 'machine-state idle';
                wsSend({ type: 'list_ports' });
                wsSend({ type: 'settings' });
                updateButtonStates();
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleMessage(msg);
            };

            ws.onclose = () => {
                connected = false;
                document.getElementById('machineState').textContent = 'DISCONNECTED';
                document.getElementById('machineState').className = 'machine-state disconnected';
                updateButtonStates();
                setTimeout(connect, 2000);
            };

            ws.onerror = () => {
                debugLog('WebSocket error', 'error');
            };
        }

        function wsSend(msg) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(msg));
            }
        }

        // ========== MESSAGE HANDLER ==========
        function handleMessage(msg) {
            switch (msg.type) {
                case 'status':       handleStatus(msg); break;
                case 'serial_read':
                    // Only log status lines with Ov: (override info)
                    if (msg.line.startsWith('<')) {
                        document.getElementById('spRaw').textContent = msg.line;
                        if (msg.line.includes('Ov:')) {
                            debugLog('< ' + msg.line);
                        }
                    } else {
                        // Non-status lines always show
                        debugLog('< ' + msg.line);
                    }
                    break;
                case 'serial_write': debugLog('> ' + msg.line, 'sent'); break;
                case 'response':     handleResponse(msg); break;
                case 'connected':    handleConnected(msg); break;
                case 'disconnected': handleDisconnected(); break;
                case 'ports':        handlePorts(msg); break;
                case 'settings':     handleSettings(msg); break;
                case 'probe':        handleProbe(msg); break;
                case 'alarm':        handleAlarm(msg); break;
                case 'file_status':  handleFileStatus(msg); break;
                case 'file_done':    handleFileDone(msg); break;
                case 'file_error':   handleFileError(msg); break;
                case 'macro_status': handleMacroStatus(msg); break;
                case 'macro_done':   handleMacroDone(msg); break;
                case 'macro_error':  handleMacroError(msg); break;
                case 'macro_log':    handleMacroLog(msg); break;
                case 'error':        debugLog('ERROR: ' + msg.message, 'error'); break;
            }
        }

        // ========== STATUS HANDLING ==========
        function handleStatus(msg) {
            const factor = currentUnit === 'in' ? 1/25.4 : 1;
            const decimals = 3;

            // Work position
            if (msg.wpos) {
                document.getElementById('workX').textContent = (msg.wpos.x * factor).toFixed(decimals);
                document.getElementById('workY').textContent = (msg.wpos.y * factor).toFixed(decimals);
                document.getElementById('workZ').textContent = (msg.wpos.z * factor).toFixed(decimals);
                document.getElementById('workA').textContent = (msg.wpos.a || 0).toFixed(3);
            }

            // Machine position
            if (msg.mpos) {
                machPosX = msg.mpos.x;
                machPosY = msg.mpos.y;
                machPosZ = msg.mpos.z;
                machPosA = msg.mpos.a || 0;

                const currentState = (msg.state || '').toUpperCase();
                const needsSync = !pendingInitialized ||
                                  (lastMachineState === 'ALARM' && currentState === 'IDLE') ||
                                  (lastMachineState === 'HOME' && currentState === 'IDLE');

                if (needsSync) {
                    pendingX = machPosX; pendingY = machPosY;
                    pendingZ = machPosZ; pendingA = machPosA;
                    pendingInitialized = true;
                }

                // Auto-sync when IDLE with desync
                if (currentState === 'IDLE') {
                    const maxDesync = Math.max(
                        Math.abs(pendingX - machPosX), Math.abs(pendingY - machPosY),
                        Math.abs(pendingZ - machPosZ), Math.abs(pendingA - machPosA)
                    );
                    if (maxDesync > 0.1) {
                        pendingX = machPosX; pendingY = machPosY;
                        pendingZ = machPosZ; pendingA = machPosA;
                    }
                    document.getElementById('debugInfo').style.background = '#3a3a3a';
                    document.getElementById('debugInfo').textContent = '\u2713 Synced';
                } else {
                    document.getElementById('debugInfo').style.background = '#3a3a3a';
                    document.getElementById('debugInfo').textContent = 'Moving...';
                }

                document.getElementById('machX').textContent = (machPosX * factor).toFixed(decimals);
                document.getElementById('machY').textContent = (machPosY * factor).toFixed(decimals);
                document.getElementById('machZ').textContent = (machPosZ * factor).toFixed(decimals);
                document.getElementById('machA').textContent = machPosA.toFixed(3);

                lastMachineState = currentState;
            }

            // Track WCO (Work Coordinate Offset) = mpos - wpos
            if (msg.mpos && msg.wpos) {
                const newWcoX = msg.mpos.x - msg.wpos.x;
                const newWcoY = msg.mpos.y - msg.wpos.y;
                const newWcoZ = msg.mpos.z - msg.wpos.z;
                // Re-check bounds if WCO changed significantly
                if (Math.abs(newWcoX - wcoX) > 0.01 || Math.abs(newWcoY - wcoY) > 0.01 || Math.abs(newWcoZ - wcoZ) > 0.01) {
                    wcoX = newWcoX;
                    wcoY = newWcoY;
                    wcoZ = newWcoZ;
                    checkBoundsWithWCO();
                }
            }

            // Machine state badge
            if (msg.state) {
                const stateEl = document.getElementById('machineState');
                const s = msg.state.toUpperCase();
                stateEl.textContent = s;
                stateEl.className = 'machine-state ' + msg.state.toLowerCase().split(':')[0];
            }

            // Overrides
            if (msg.feed_override !== undefined) {
                currentFeedOverride = msg.feed_override;
                document.getElementById('feedRate').textContent = msg.feed_override + '%';
            }
            if (msg.spindle_override !== undefined) {
                currentSpindleOverride = msg.spindle_override;
                document.getElementById('spindleOverride').textContent = msg.spindle_override + '%';
            }

            // Spindle RPM - GRBL reports actual speed (already override-adjusted) in FS:
            if (msg.spindle_speed !== undefined) {
                if (msg.spindle_speed > 0) lastSpindleSpeed = msg.spindle_speed;
                document.getElementById('spindleRPMValue').textContent = msg.spindle_speed || 0;
                // Track spindle state from controller status
                spindleRunning = msg.spindle_speed > 0;
                updateSpindleDisplay();
            }

            // Feed rate
            if (msg.feed_rate !== undefined) {
                currentFeedRate = msg.feed_rate || 0;
                const feed = currentFeedRate;
                const unit = currentUnit === 'in' ? 'in' : 'mm';
                const displayFeed = currentUnit === 'in' ? Math.round(feed / 25.4) : Math.round(feed);
                document.getElementById('machineSpeedValue').textContent = displayFeed;
                document.getElementById('machineSpeedUnit').textContent = unit + '/min';
            }

            // Update status panel
            if (msg.state) {
                document.getElementById('spState').textContent = msg.state.toUpperCase();
            }
            if (msg.feed_override !== undefined) {
                document.getElementById('spFeedOv').textContent = msg.feed_override + '%';
            }
            if (msg.rapid_override !== undefined) {
                document.getElementById('spRapidOv').textContent = msg.rapid_override + '%';
            }
            if (msg.spindle_override !== undefined) {
                document.getElementById('spSpindleOv').textContent = msg.spindle_override + '%';
            }
            if (msg.feed_rate !== undefined) {
                document.getElementById('spFeed').textContent = Math.round(msg.feed_rate) + ' mm/min';
            }
            if (msg.spindle_speed !== undefined) {
                document.getElementById('spSpindle').textContent = msg.spindle_speed + ' RPM';
            }

            updateButtonStates();
        }

        function handleResponse(msg) {
            if (msg.result && msg.result.startsWith('error')) {
                debugLog('ERROR: ' + msg.result + ' (cmd: ' + msg.to + ')', 'error');
            }
        }

        function handleConnected(msg) {
            connected = true;
            currentPort = msg.port;
            document.getElementById('machineState').textContent = 'CONNECTED';
            document.getElementById('machineState').className = 'machine-state idle';
            debugLog('Connected to ' + msg.port, 'info');
            updateButtonStates();
        }

        function handleDisconnected() {
            connected = false;
            document.getElementById('machineState').textContent = 'DISCONNECTED';
            document.getElementById('machineState').className = 'machine-state disconnected';
            updateButtonStates();
        }

        function handlePorts(msg) {
            const select = document.getElementById('portSelect');
            select.innerHTML = '<option value="">Select port...</option>';
            (msg.ports || []).forEach(port => {
                const opt = document.createElement('option');
                opt.value = port;
                opt.textContent = port;
                if (port === currentPort) opt.selected = true;
                select.appendChild(opt);
            });
        }

        function handleSettings(msg) {
            const s = msg.settings || {};
            if (s['$130']) workMaxX = parseFloat(s['$130']);
            if (s['$131']) workMaxY = parseFloat(s['$131']);
            if (s['$132']) workMaxZ = parseFloat(s['$132']);
            if (s['$133']) workMaxA = parseFloat(s['$133']);
            if (s['$30']) spindleMaxRPM = Math.floor(parseFloat(s['$30']) / 1000) * 1000;
            if (s['$31']) spindleMinRPM = Math.ceil(parseFloat(s['$31']) / 1000) * 1000;
            document.getElementById('debugInfo').textContent =
                '$130: ' + workMaxX + ' | $131: ' + workMaxY + ' | $132: ' + workMaxZ;
        }

        function handleProbe(msg) {
            debugLog('\u2605 PROBE ' + (msg.success ? 'HIT' : 'MISS') +
                ' X=' + msg.x.toFixed(3) + ' Y=' + msg.y.toFixed(3) + ' Z=' + msg.z.toFixed(3), 'info');
        }

        function handleAlarm(msg) {
            debugLog('ALARM:' + msg.code + ' ' + (msg.message || ''), 'error');
            lastMachineState = 'ALARM';
            const stateEl = document.getElementById('machineState');
            stateEl.textContent = 'ALARM';
            stateEl.className = 'machine-state alarm';
            updateButtonStates();
        }

        // ========== FILE STREAMING ==========
        let loadedFileName = '';

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                wsSend({ type: 'file_upload', filename: file.name, content: content });
                loadedFileName = file.name;
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileName').style.textDecoration = 'none';
                fileLoaded = true;
                debugLog('File loaded: ' + file.name, 'info');
                // Update G-code viewer
                updateGcodeViewer(content.split('\n'), 0);
                // Show start job dialog
                openStartJobModal();
            };
            reader.readAsText(file);
        }

        let startSpindleSpeed = 12000;

        function openStartJobModal() {
            document.getElementById('startLine').value = '1';
            document.getElementById('spindleFirst').checked = false;
            startSpindleSpeed = 12000;
            document.getElementById('startSpindleSpeed').textContent = '12000';
            document.getElementById('spindleSpeedSelector').style.display = 'none';
            document.getElementById('startJobModal').style.display = 'flex';
        }

        function closeStartJobModal() {
            document.getElementById('startJobModal').style.display = 'none';
        }

        function updateSpindleSpeedDisplay() {
            const checked = document.getElementById('spindleFirst').checked;
            document.getElementById('spindleSpeedSelector').style.display = checked ? 'block' : 'none';
        }

        function adjustStartSpindle(delta) {
            startSpindleSpeed = Math.max(1000, Math.min(30000, startSpindleSpeed + delta));
            document.getElementById('startSpindleSpeed').textContent = startSpindleSpeed;
        }

        function startJobFromModal() {
            const fromLine = parseInt(document.getElementById('startLine').value) || 1;
            const spindleFirst = document.getElementById('spindleFirst').checked;

            closeStartJobModal();

            // Turn on spindle first if requested
            if (spindleFirst) {
                wsSend({ type: 'gcode', line: 'M3 S' + startSpindleSpeed });
                debugLog('Spindle ON (M3 S' + startSpindleSpeed + ')', 'info');
            }

            // Start streaming
            const payload = { type: 'file_start' };
            if (fromLine > 1) payload.from_line = fromLine;
            wsSend(payload);
            debugLog('Starting from line ' + fromLine, 'info');
        }

        function handleFileStatus(msg) {
            document.getElementById('fileName').textContent = msg.filename || '';
            const pct = (msg.percent || 0).toFixed(1);
            document.getElementById('lineProgress').textContent =
                msg.current + '/' + msg.total;
            document.getElementById('progressFill').style.width = pct + '%';
            if (msg.current_gcode) {
                document.getElementById('gcodeInput').placeholder = 'L' + msg.current + ': ' + msg.current_gcode;
            }
            // Update G-code viewer with current line highlight
            if (msg.current > 0 && currentView === 'gcode') {
                updateGcodeViewer(null, msg.current);
            }
            // Update recovery info
            if (msg.last_safe_line) {
                lastSafeLine = msg.last_safe_line;
                lastSafeGcode = msg.last_safe_gcode || '';
            }
            // Display file analysis stats
            if (msg.analysis) {
                const a = msg.analysis;
                let stats = [];
                if (a.max_feed > 0) stats.push('F' + a.max_feed);
                if (a.max_plunge > 0) stats.push('P' + a.max_plunge);
                if (a.max_spindle > 0) {
                    if (a.min_spindle === a.max_spindle) {
                        stats.push('S' + a.max_spindle);
                    } else {
                        stats.push('S' + a.min_spindle + '-' + a.max_spindle);
                    }
                }
                if (a.tool_changes > 0) stats.push('T' + a.tool_changes);
                document.getElementById('fileStats').textContent = stats.join(' | ');
                // Store tool change data for time estimation
                toolChangeLines = a.tool_change_lines || [];
                timeToNextTC = a.time_to_next_tc || [];
                totalFileTime = a.total_time || 0;

                // Store bounds and check against machine limits (considering WCO)
                gcodeBounds = a.bounds || null;
                checkBoundsWithWCO();
            }

            // Update job progress (time remaining, time to next TC)
            updateJobProgress(msg.current);
        }

        function updateJobProgress(currentLine) {
            const timeRemainingEl = document.getElementById('timeRemaining');
            const timeToTCEl = document.getElementById('timeToTC');

            // No data available
            if (!timeToNextTC.length) {
                timeRemainingEl.textContent = '--:--';
                timeToTCEl.textContent = '--:-- to M6';
                return;
            }

            // Use line 1 if not streaming yet (currentLine is 0)
            const lineIndex = currentLine < 1 ? 0 : Math.min(currentLine - 1, timeToNextTC.length - 1);

            // Get precomputed time remaining to next tool change (in minutes)
            const baseTimeToTC = timeToNextTC[lineIndex];

            // Adjust by feed override (e.g., 80% feed = time takes longer)
            const adjustedTimeToTC = baseTimeToTC / (currentFeedOverride / 100);

            // Calculate total time remaining (from current line to end)
            // timeToNextTC at line 0 gives time to first TC, but we need time to end
            // Use cumulative time if available, otherwise estimate from line position
            const lineRatio = lineIndex / Math.max(timeToNextTC.length - 1, 1);
            const adjustedTotalTime = totalFileTime / (currentFeedOverride / 100);
            const timeRemaining = adjustedTotalTime * (1 - lineRatio);

            // Format time remaining
            if (timeRemaining > 0) {
                const mins = Math.floor(timeRemaining);
                const secs = Math.floor((timeRemaining - mins) * 60);
                timeRemainingEl.textContent = mins + ':' + secs.toString().padStart(2, '0');
            } else {
                timeRemainingEl.textContent = '--:--';
            }

            // Format time to next TC
            if (adjustedTimeToTC > 0) {
                const mins = Math.floor(adjustedTimeToTC);
                const secs = Math.floor((adjustedTimeToTC - mins) * 60);
                const timeStr = mins + ':' + secs.toString().padStart(2, '0');

                // Find which tool change we're approaching
                const effectiveLine = currentLine < 1 ? 1 : currentLine;
                let nextTC = 1;
                for (let i = 0; i < toolChangeLines.length; i++) {
                    if (toolChangeLines[i] > effectiveLine) {
                        nextTC = i + 1;
                        break;
                    }
                    nextTC = i + 2;  // Past last TC
                }

                if (nextTC <= toolChangeLines.length) {
                    timeToTCEl.textContent = timeStr + ' to M6';
                } else {
                    timeToTCEl.textContent = timeStr + ' to end';
                }
            } else {
                timeToTCEl.textContent = '--:-- to M6';
            }
        }

        function checkBoundsWithWCO() {
            // Check G-code bounds against machine limits, considering current Work Coordinate Offset
            // Machine position = work position + WCO
            // Machine limits: 0 (home) to -workMax (far end)
            const boundsEl = document.getElementById('boundsWarning');
            boundsEl.style.color = '#f55';  // Default red for warnings

            if (!gcodeBounds) {
                boundsEl.textContent = '';
                return;
            }

            const b = gcodeBounds;
            let warnings = [];

            // Calculate machine positions for G-code bounds
            // Machine coords are typically negative (0 at home, -400 at far end)
            // mpos = wpos + WCO
            const machMinX = b.min_x + wcoX;
            const machMaxX = b.max_x + wcoX;
            const machMinY = b.min_y + wcoY;
            const machMaxY = b.max_y + wcoY;
            const machMinZ = b.min_z + wcoZ;
            const machMaxZ = b.max_z + wcoZ;

            // Check against machine limits (0 to -workMax)
            if (machMaxX > 0.1) warnings.push('X>' + machMaxX.toFixed(0));
            if (machMinX < -workMaxX - 0.1) warnings.push('X<' + machMinX.toFixed(0));
            if (machMaxY > 0.1) warnings.push('Y>' + machMaxY.toFixed(0));
            if (machMinY < -workMaxY - 0.1) warnings.push('Y<' + machMinY.toFixed(0));
            if (machMaxZ > 0.1) warnings.push('Z>' + machMaxZ.toFixed(0));
            if (machMinZ < -workMaxZ - 0.1) warnings.push('Z<' + machMinZ.toFixed(0));

            if (warnings.length > 0) {
                boundsEl.textContent = ' LIMITS: ' + warnings.join(', ');
            } else {
                boundsEl.textContent = ' OK';
                boundsEl.style.color = '#6a6';
            }
        }

        function handleFileDone(msg) {
            debugLog('=== FILE COMPLETE: ' + msg.filename + ' (' + msg.total + ' lines) ===', 'info');
            document.getElementById('progressFill').style.width = '100%';
        }

        function handleFileError(msg) {
            debugLog('FILE ERROR at line ' + msg.line + ': ' + msg.error + ' [' + msg.gcode + ']', 'error');
        }

        // ========== MACRO HANDLING ==========
        function handleMacroLog(msg) {
            // Log macro progress to debug console (no modal)
            debugLog('[' + (msg.name || 'MACRO') + '] ' + msg.message, 'info');
            // Show G-code commands in the input box (messages starting with "> ")
            if (msg.message && msg.message.startsWith('> ')) {
                const gcode = msg.message.substring(2);
                const input = document.getElementById('gcodeInput');
                input.value = gcode;
                input.style.color = '#0f0';  // Green to show it's macro-generated
            }
        }

        function handleMacroStatus(msg) {
            macroRunning = true;
            updateButtonStates();
            // Log status to console instead of showing modal
            debugLog('[' + (msg.name || 'MACRO') + '] Step ' + msg.step + '/' + msg.total + ': ' + msg.description, 'info');
            // Show CONTINUE overlay when waiting for user (tool change)
            if (msg.waiting) {
                document.getElementById('continueOverlay').style.display = 'flex';
            }
        }

        function handleMacroDone(msg) {
            macroRunning = false;
            document.getElementById('continueOverlay').style.display = 'none';
            const input = document.getElementById('gcodeInput');
            input.value = '';
            input.style.color = '#fff';  // Reset color
            debugLog('=== MACRO COMPLETE: ' + msg.name + ' ===', 'info');
            if (msg.name === 'set_z') setZDone = true;
            updateButtonStates();
        }

        function handleMacroError(msg) {
            macroRunning = false;
            document.getElementById('continueOverlay').style.display = 'none';
            const input = document.getElementById('gcodeInput');
            input.value = '';
            input.style.color = '#fff';  // Reset color
            debugLog('MACRO ERROR (' + msg.name + '): ' + msg.error, 'error');
            updateButtonStates();
        }

        function macroCancel() {
            wsSend({ type: 'macro_cancel' });
            document.getElementById('continueOverlay').style.display = 'none';
        }

        function macroContinue() {
            wsSend({ type: 'macro_continue' });
        }

        // ========== COMMANDS ==========
        function cmd(gcode) {
            if (!connected) return;
            wsSend({ type: 'gcode', line: gcode });
        }

        function sendRealtime(byte) {
            if (!connected) return;
            wsSend({ type: 'realtime', byte: byte });
        }

        function sendGcodeInput() {
            const input = document.getElementById('gcodeInput');
            const gcode = input.value.trim();
            if (gcode) {
                // Check if it's a hex realtime command (0x## or 0X##)
                if (/^0x[0-9a-fA-F]{1,2}$/i.test(gcode)) {
                    const byte = parseInt(gcode, 16);
                    debugLog('Sending realtime byte: 0x' + byte.toString(16).toUpperCase(), 'info');
                    sendRealtime(byte);
                } else {
                    cmd(gcode);
                }
                input.value = '';
            }
            input.focus();
        }

        function unlock() { wsSend({ type: 'unlock' }); }
        function doReset() { wsSend({ type: 'reset' }); }

        function changePort(port) {
            if (port) wsSend({ type: 'connect', port: port });
        }

        function refreshPorts() {
            wsSend({ type: 'list_ports' });
        }

        // ========== MOTION ==========
        function isWithinLimits(targetX, targetY, targetZ, targetA) {
            if (targetX !== null && (targetX > 0.01 || targetX < -workMaxX)) return false;
            if (targetY !== null && (targetY > 0.01 || targetY < -workMaxY)) return false;
            if (targetZ !== null && (targetZ > 0.01 || targetZ < -workMaxZ)) return false;
            return true;
        }

        function showBlocked(msg) {
            const el = document.getElementById('debugInfo');
            const orig = el.style.background;
            el.style.background = '#6a2a2a';
            el.textContent = msg;
            setTimeout(() => {
                el.style.background = orig;
                el.textContent = '$130: ' + workMaxX + ' | $131: ' + workMaxY + ' | $132: ' + workMaxZ;
            }, 2000);
        }

        function gotoXY(x, y) {
            const targetX = -x;
            const targetY = -y;
            if (!isWithinLimits(targetX, targetY, null)) {
                showBlocked('BLOCKED: X' + targetX.toFixed(1) + ' Y' + targetY.toFixed(1));
                return;
            }
            pendingX = targetX;
            pendingY = targetY;
            cmd('G53 G0 X' + targetX.toFixed(1) + ' Y' + targetY.toFixed(1));
        }

        let jogStep = 2.5;
        let jogCounter = 0;

        function jog(axis, dir) {
            jogCounter++;
            const dist = jogStep * dir;
            let targetX = pendingX, targetY = pendingY, targetZ = pendingZ, targetA = pendingA;
            if (axis === 'X') targetX += dist;
            if (axis === 'Y') targetY += dist;
            if (axis === 'Z') targetZ += dist;
            if (axis === 'A') targetA += dist;

            if (!isWithinLimits(targetX, targetY, targetZ, targetA)) {
                showBlocked('BLOCKED: ' + axis + (dist > 0 ? '+' : '') + dist + ' \u2192 ' +
                    (axis === 'X' ? targetX : axis === 'Y' ? targetY : axis === 'Z' ? targetZ : targetA).toFixed(1));
                return;
            }

            pendingX = targetX; pendingY = targetY;
            pendingZ = targetZ; pendingA = targetA;
            cmd('G91 G0 ' + axis + dist);
            cmd('G90');
        }

        function setStep(step, btn) {
            jogStep = step;
            document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // ========== OVERRIDES ==========
        let currentFeedOverride = 100;
        function feedOverride(delta) {
            if (!connected) return;
            let byte;
            if (delta === 0) { byte = 0x90; currentFeedOverride = 100; }
            else if (delta === 10) { byte = 0x91; currentFeedOverride = Math.min(200, currentFeedOverride + 10); }
            else if (delta === -10) { byte = 0x92; currentFeedOverride = Math.max(10, currentFeedOverride - 10); }
            else if (delta === 1) { byte = 0x93; currentFeedOverride = Math.min(200, currentFeedOverride + 1); }
            else if (delta === -1) { byte = 0x94; currentFeedOverride = Math.max(10, currentFeedOverride - 1); }
            if (byte) sendRealtime(byte);
            document.getElementById('feedRate').textContent = currentFeedOverride + '%';
        }

        let currentSpindleOverride = 100;
        let spindleRunning = false;

        // Toggle spindle: click RPM to turn on (M3 S12000) or off (M5)
        function spindleOn() {
            if (!connected) return;
            if (!spindleRunning) {
                // Turn on at S12000
                cmd('M3 S12000');
                spindleRunning = true;
                currentSpindleOverride = 100;
                updateSpindleDisplay();
            } else {
                // Already on - turn off
                spindleOff();
            }
        }

        function spindleOff() {
            if (!connected) return;
            sendRealtime(0x99);  // Reset spindle override to 100% first
            cmd('M5');
            spindleRunning = false;
            currentSpindleOverride = 100;
            updateSpindleDisplay();
            debugLog('Spindle OFF', 'info');
        }

        function spindleResetOverride() {
            if (!connected) return;
            sendRealtime(0x99);
            currentSpindleOverride = 100;
            updateSpindleDisplay();
        }

        function spindleOverride(delta) {
            if (!connected) return;

            // Capture old values BEFORE sending override command
            const oldOverride = currentSpindleOverride;
            const oldSpeed = lastSpindleSpeed;

            debugLog('spindleOverride(' + delta + ') spindleRunning=' + spindleRunning + ' currentOverride=' + oldOverride + ' lastSpeed=' + oldSpeed, 'info');

            let byte;
            let newOverride = currentSpindleOverride;

            if (delta === 10) { byte = 0x9A; newOverride = Math.min(200, currentSpindleOverride + 10); }
            else if (delta === -10) { byte = 0x9B; newOverride = currentSpindleOverride - 10; }
            else if (delta === 1) { byte = 0x9C; newOverride = Math.min(200, currentSpindleOverride + 1); }
            else if (delta === -1) { byte = 0x9D; newOverride = currentSpindleOverride - 1; }

            // Going below 10% means stop spindle
            if (newOverride < 10) {
                // Reset override first (while spindle still on), then turn off
                sendRealtime(0x99);  // Reset spindle override to 100%
                cmd('M5');
                spindleRunning = false;
                currentSpindleOverride = 100;
                updateSpindleDisplay();
                // If feed is active (job running), also pause
                if (currentFeedRate > 0) {
                    sendRealtime(0x21); // Feed hold (!)
                    debugLog('Spindle stopped - feed paused', 'info');
                } else {
                    debugLog('Spindle stopped', 'info');
                }
                return;
            }

            currentSpindleOverride = newOverride;
            debugLog('Sending realtime 0x' + byte.toString(16) + ' newOverride=' + newOverride, 'info');
            sendRealtime(byte);

            // Force-apply when idle using S(base+1) instead of Z jog
            if (spindleRunning && lastMachineState === 'IDLE' && oldSpeed > 0) {
                // Calculate base S value: base = current_speed / (old_override / 100)
                const base = Math.round(oldSpeed / (oldOverride / 100));
                const forceSpeed = base + 1;
                debugLog('Force-apply: S' + forceSpeed + ' (base=' + base + ' from speed=' + oldSpeed + ' override=' + oldOverride + '%)', 'info');
                cmd('S' + forceSpeed);
            }
            updateSpindleDisplay();
        }

        function updateSpindleDisplay() {
            const el = document.getElementById('spindleOverride');
            el.textContent = currentSpindleOverride + '%';
            if (spindleRunning) {
                el.style.background = '#2a4a2a';
                el.style.color = '#6f6';
            } else {
                el.style.background = '#333';
                el.style.color = '#888';
            }
        }

        // Debug spindle test - moves Z down slowly while adjusting spindle speed
        let debugSpindleRunning = false;
        async function debugSpindleTest() {
            if (debugSpindleRunning) {
                debugLog('Debug test already running', 'error');
                return;
            }
            debugSpindleRunning = true;
            const btn = document.getElementById('debugSpindleBtn');
            btn.style.background = '#2a4a2a';

            debugLog('=== DEBUG SPINDLE TEST START ===', 'info');

            // Reset overrides to 100% first
            sendRealtime(0x90);
            sendRealtime(0x99);

            // M3 S10000
            debugLog('> M3 S10000 (waiting 10s for spindle)', 'sent');
            cmd('M3 S10000');
            await new Promise(r => setTimeout(r, 10000));

            // -10%
            debugLog('> 0x9B (-10%)', 'sent');
            sendRealtime(0x9B);
            await new Promise(r => setTimeout(r, 1000));

            // G1 Z-1 F10
            debugLog('> G91 G1 Z-1 F10', 'sent');
            cmd('G91');
            cmd('G1 Z-1 F10');
            await new Promise(r => setTimeout(r, 7000));  // ~6 sec move + buffer

            // -10%
            debugLog('> 0x9B (-10%)', 'sent');
            sendRealtime(0x9B);
            cmd('G90');

            debugLog('=== DEBUG SPINDLE TEST COMPLETE (spindle still running) ===', 'info');
            btn.style.background = '#4a2a2a';
            debugSpindleRunning = false;
        }

        // ========== JOB CONTROL ==========
        function jobStart() {
            if (spindleWasRunning) {
                sendRealtime(0x9E); // Toggle spindle back on
                spindleWasRunning = false;
                setTimeout(() => {
                    wsSend({ type: 'cycle_start' });
                    wsSend({ type: 'file_resume' });
                    streamerPaused = false;
                }, 5000);
            } else if (lastMachineState.startsWith('HOLD')) {
                wsSend({ type: 'cycle_start' });
                if (streamerPaused) {
                    wsSend({ type: 'file_resume' });
                    streamerPaused = false;
                }
            } else {
                wsSend({ type: 'file_start' });
            }
        }

        function jobPause() {
            wsSend({ type: 'feed_hold' });
            wsSend({ type: 'file_pause' });
            streamerPaused = true;
            spindleWasRunning = true;
            sendRealtime(0x9E); // Spindle stop override
        }

        function jobStop() {
            wsSend({ type: 'file_stop' });
            sendRealtime(0x9E);
            spindleWasRunning = false;
            streamerPaused = false;
        }

        // ========== MACROS ==========
        function runMacro(name) {
            if (!connected) return;
            if (name === 'HOMING') {
                cmd('$H');
                return;
            }
            if (name === 'tool_change' && !setZDone) {
                alert('Run Set Z first!');
                return;
            }
            debugLog('=== MACRO: ' + name + ' ===', 'info');
            wsSend({ type: 'macro_run', name: name });
        }

        // ========== ZERO PROBES ==========
        let pendingProbe = '';

        function runProbe(name) {
            if (!connected) return;
            debugLog('=== PROBE: ' + name + ' ===', 'info');
            wsSend({ type: 'macro_run', name: name });
        }

        function showProbeModal(probeName) {
            if (!connected) return;
            pendingProbe = probeName;
            document.getElementById('probeModal').classList.add('open');
        }

        function closeProbeModal() {
            document.getElementById('probeModal').classList.remove('open');
            pendingProbe = '';
        }

        function runProbeWithDia(toolDiameter) {
            if (!pendingProbe) return;
            debugLog('=== PROBE: ' + pendingProbe + ' (tool=' + toolDiameter + 'mm) ===', 'info');
            wsSend({ type: 'macro_run', name: pendingProbe, tool_diameter: toolDiameter });
            closeProbeModal();
        }

        // ========== UNITS ==========
        let currentUnit = 'mm';
        const mmSteps = [0.025, 0.25, 2.5, 25];
        const inSteps = [0.001, 0.01, 0.1, 1];

        function toggleUnits() {
            if (currentUnit === 'mm') {
                currentUnit = 'in';
                cmd('G20');
            } else {
                currentUnit = 'mm';
                cmd('G21');
            }
            document.getElementById('unitDisplay').textContent = currentUnit;
            updateStepButtons();
        }

        function updateStepButtons() {
            const steps = currentUnit === 'mm' ? mmSteps : inSteps;
            const container = document.getElementById('stepButtons');
            document.getElementById('stepLabel').innerHTML =
                '<span style="color:#555">&lt;</span><span>Step (' + currentUnit + ')</span><span style="color:#555">&gt;</span>';
            container.innerHTML = '';
            steps.forEach((step) => {
                const btn = document.createElement('button');
                btn.className = 'step-btn';
                btn.textContent = step;
                btn.style.cssText = 'padding:4px 6px; font-size:10px;';
                btn.onclick = function() { setStep(step, this); };
                if ((currentUnit === 'mm' && step === 2.5) || (currentUnit === 'in' && step === 0.1)) {
                    btn.classList.add('active');
                    jogStep = step;
                }
                container.appendChild(btn);
            });
        }

        // ========== BUTTON STATES ==========
        function updateButtonStates() {
            const gcodeInput = document.getElementById('gcodeInput');

            if (!connected) {
                document.getElementById('btnRun').disabled = true;
                document.getElementById('btnPause').disabled = true;
                document.getElementById('btnStop').disabled = true;
                document.getElementById('btnUnlock').disabled = true;
                document.getElementById('btnReset').disabled = true;
                document.getElementById('btnHome').disabled = true;
                document.querySelectorAll('.goto-btn').forEach(btn => btn.disabled = true);
                document.querySelectorAll('button[onclick^="runMacro"]').forEach(btn => btn.disabled = true);
                document.querySelectorAll('button[onclick^="jog("], .xy-grid button, .step-btn').forEach(btn => btn.disabled = true);
                gcodeInput.disabled = true;
                return;
            }

            // During macro run, disable most controls except stop/reset
            if (macroRunning) {
                document.getElementById('btnRun').disabled = true;
                document.getElementById('btnPause').disabled = true;
                document.getElementById('btnStop').disabled = false;  // Allow stop
                document.getElementById('btnUnlock').disabled = true;
                document.getElementById('btnReset').disabled = false;  // Allow reset
                document.getElementById('btnHome').disabled = true;
                document.querySelectorAll('.goto-btn').forEach(btn => btn.disabled = true);
                document.querySelectorAll('button[onclick^="runMacro"]').forEach(btn => btn.disabled = true);
                document.querySelectorAll('button[onclick^="jog("], .xy-grid button, .step-btn').forEach(btn => btn.disabled = true);
                gcodeInput.disabled = true;
                return;
            }

            const state = lastMachineState;
            document.getElementById('btnRun').disabled = !state.startsWith('HOLD');
            document.getElementById('btnPause').disabled = !(state === 'IDLE' || state === 'RUN');
            document.getElementById('btnStop').disabled = !(state === 'RUN' || streamerPaused || macroRunning);
            document.getElementById('btnUnlock').disabled = !(state === 'ALARM');
            document.getElementById('btnReset').disabled = false;
            document.getElementById('btnHome').disabled = !(state === 'IDLE');

            const jogEnabled = (state === 'IDLE');
            document.querySelectorAll('.goto-btn').forEach(btn => btn.disabled = !jogEnabled);
            document.querySelectorAll('button[onclick^="runMacro"]').forEach(btn => {
                if (!btn.id || btn.id !== 'btnHome') btn.disabled = !jogEnabled;
            });
            document.querySelectorAll('button[onclick^="jog("], .xy-grid button, .step-btn').forEach(btn => btn.disabled = !jogEnabled);
            gcodeInput.disabled = !jogEnabled;
        }

        // ========== DIALOGS ==========
        let confirmCb = null;
        function showConfirm(msg, cb) {
            document.getElementById('confirmMsg').textContent = msg;
            document.getElementById('confirmModal').classList.add('open');
            confirmCb = cb;
        }
        function confirmResolve(yes) {
            document.getElementById('confirmModal').classList.remove('open');
            if (confirmCb) confirmCb(yes);
            confirmCb = null;
        }

        function homeA() {
            if (!connected) return;
            showConfirm('Unplug A axis stepper, then click Yes', (yes) => {
                if (!yes) return;
                cmd('$113=1000000');
                cmd('$123=1000000');
                cmd('G91');
                cmd('G0 A-40000');
                cmd('G90');
                setTimeout(() => {
                    showConfirm('Plug A axis stepper back in, then click Yes', (yes2) => {
                        if (!yes2) return;
                        cmd('$113=50');
                        cmd('$123=20');
                        cmd('G10 L20 P1 A0');
                        debugLog('Home A complete: machine A reset, work A zeroed', 'info');
                    });
                }, 5000);
            });
        }

        function hideContinue() {
            document.getElementById('continueOverlay').style.display = 'none';
        }

        // ========== WORK COORDINATE MODAL ==========
        let currentWorkCoords = { x: 0, y: 0, z: 0, a: 0 };

        function openWorkModal() {
            const x = parseFloat(document.getElementById('workX').textContent) || 0;
            const y = parseFloat(document.getElementById('workY').textContent) || 0;
            const z = parseFloat(document.getElementById('workZ').textContent) || 0;
            const a = parseFloat(document.getElementById('workA').textContent) || 0;
            currentWorkCoords = { x, y, z, a };
            document.getElementById('modalX').value = x.toFixed(3);
            document.getElementById('modalY').value = y.toFixed(3);
            document.getElementById('modalZ').value = z.toFixed(3);
            document.getElementById('modalA').value = a.toFixed(3);
            document.getElementById('workModal').classList.add('open');
            document.getElementById('modalX').focus();
        }

        function closeWorkModal() {
            document.getElementById('workModal').classList.remove('open');
        }

        function applyWorkCoords() {
            const newX = parseFloat(document.getElementById('modalX').value);
            const newY = parseFloat(document.getElementById('modalY').value);
            const newZ = parseFloat(document.getElementById('modalZ').value);
            const newA = parseFloat(document.getElementById('modalA').value);

            const xChanged = Math.abs(newX - currentWorkCoords.x) > 0.0001;
            const yChanged = Math.abs(newY - currentWorkCoords.y) > 0.0001;
            const zChanged = Math.abs(newZ - currentWorkCoords.z) > 0.0001;
            const aChanged = Math.abs(newA - currentWorkCoords.a) > 0.0001;

            let parts = [];
            if (xChanged) parts.push('X' + newX.toFixed(3));
            if (yChanged) parts.push('Y' + newY.toFixed(3));
            if (zChanged) parts.push('Z' + newZ.toFixed(3));
            if (aChanged) parts.push('A' + newA.toFixed(3));
            if (parts.length > 0) {
                cmd('G10 L20 P1 ' + parts.join(' '));
                // If Z was changed, run SetZ macro after a delay
                if (zChanged) {
                    setTimeout(() => runMacro('set_z'), 500);
                }
            }

            closeWorkModal();
        }

        function zeroZAndSetZ() {
            cmd('G10 L20 P1 Z0');
            setTimeout(() => runMacro('set_z'), 500);
        }

        // ========== DEBUG CONSOLE ==========
        function debugLog(msg, type) {
            type = type || '';
            const log = document.getElementById('debugLog');
            const line = document.createElement('div');
            line.className = 'debug-line' + (type ? ' ' + type : '');
            line.textContent = new Date().toLocaleTimeString() + ' ' + msg;
            log.appendChild(line);
            while (log.children.length > 200) {
                log.removeChild(log.firstChild);
            }
            const content = document.getElementById('debugContent');
            content.scrollTop = content.scrollHeight;
        }

        function toggleDebug() {
            const content = document.getElementById('debugContent');
            const toggle = document.getElementById('debugToggle');
            content.classList.toggle('open');
            toggle.textContent = content.classList.contains('open') ? '\u25B2' : '\u25BC';
        }

        function toggleStatusLog() {
            showStatusLog = !showStatusLog;
            const btn = document.getElementById('statusToggle');
            btn.style.background = showStatusLog ? '#2a4a2a' : '#4a2a2a';
        }

        function copyDebugLog(e) {
            e.stopPropagation();
            const log = document.getElementById('debugLog');
            const text = Array.from(log.children).map(el => el.textContent).join('\n');
            const btn = e.target;
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    btn.textContent = 'Copied!';
                    setTimeout(() => btn.textContent = 'Copy', 1500);
                }).catch(() => copyFallback(text, btn));
            } else {
                copyFallback(text, btn);
            }
        }

        function copyFallback(text, btn) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy', 1500);
            } catch (err) {
                btn.textContent = 'Failed';
                setTimeout(() => btn.textContent = 'Copy', 1500);
            }
            document.body.removeChild(textarea);
        }

        // ========== KEYBOARD SHORTCUTS ==========
        function cycleStep(direction) {
            const steps = currentUnit === 'mm' ? mmSteps : inSteps;
            const currentIndex = steps.indexOf(jogStep);
            const newIndex = Math.max(0, Math.min(steps.length - 1, currentIndex + direction));
            if (newIndex !== currentIndex) {
                jogStep = steps[newIndex];
                document.querySelectorAll('.step-btn').forEach((btn, i) => {
                    btn.classList.toggle('active', i === newIndex);
                });
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            if (e.key === '>' || e.key === '.') { e.preventDefault(); cycleStep(1); return; }
            if (e.key === '<' || e.key === ',') { e.preventDefault(); cycleStep(-1); return; }
            if (e.key === 'ArrowUp') { e.preventDefault(); jog('Y', 1); return; }
            if (e.key === 'ArrowDown') { e.preventDefault(); jog('Y', -1); return; }
            if (e.key === 'ArrowLeft') { e.preventDefault(); jog('X', -1); return; }
            if (e.key === 'ArrowRight') { e.preventDefault(); jog('X', 1); return; }
            if (e.key === 'PageUp') { e.preventDefault(); jog('Z', 1); return; }
            if (e.key === 'PageDown') { e.preventDefault(); jog('Z', -1); return; }
            if (e.key === 'Home') { e.preventDefault(); jog('A', -1); return; }
            if (e.key === 'End') { e.preventDefault(); jog('A', 1); return; }
        });

        // ========== CAMERA ==========
        // ========== VIEW TOGGLE ==========
        let currentView = 'camera';
        let gcodeLines = [];
        let gcodeCurrentLine = 0;
        let userScrolling = false;
        let userScrollTimeout = null;

        function showView(view) {
            currentView = view;
            // Use visibility instead of display so camera maintains container size
            document.getElementById('camera').style.visibility = view === 'camera' ? 'visible' : 'hidden';
            document.getElementById('gcodeViewer').style.display = view === 'gcode' ? 'block' : 'none';
            document.getElementById('btnViewCamera').style.background = view === 'camera' ? '#2a4a2a' : '#333';
            document.getElementById('btnViewCamera').style.borderColor = view === 'camera' ? '#3a6a3a' : '#555';
            document.getElementById('btnViewGcode').style.background = view === 'gcode' ? '#2a4a2a' : '#333';
            document.getElementById('btnViewGcode').style.borderColor = view === 'gcode' ? '#3a6a3a' : '#555';
            // Refresh gcode view when switching to it
            if (view === 'gcode' && gcodeLines.length) {
                updateGcodeViewer(null, gcodeCurrentLine);
            }
        }

        function updateGcodeViewer(lines, currentLine) {
            if (lines) gcodeLines = lines;
            if (currentLine !== undefined) gcodeCurrentLine = currentLine;

            const container = document.getElementById('gcodeViewer');
            if (!gcodeLines.length) {
                container.innerHTML = '<span style="color:#666;">No file loaded</span>';
                return;
            }

            // Only update highlight, not full rebuild (for performance during streaming)
            const existingLines = container.querySelectorAll('div[data-line]');
            if (existingLines.length === gcodeLines.length) {
                // Just update highlight
                existingLines.forEach(el => {
                    const lineNum = parseInt(el.dataset.line);
                    if (lineNum === gcodeCurrentLine) {
                        el.style.background = '#2a4a2a';
                        el.style.color = '#fff';
                    } else {
                        el.style.background = '';
                        el.style.color = '#aaa';
                    }
                });
            } else {
                // Full rebuild
                let html = '';
                for (let i = 0; i < gcodeLines.length; i++) {
                    const lineNum = i + 1;
                    const isCurrent = lineNum === gcodeCurrentLine;
                    const lineStyle = isCurrent ? 'background:#2a4a2a; color:#fff;' : 'color:#aaa;';
                    const numStyle = 'color:#555; display:inline-block; width:5ch; text-align:right; margin-right:8px;';
                    html += '<div data-line="' + lineNum + '" style="' + lineStyle + ' white-space:pre;"><span style="' + numStyle + '">' + lineNum + '</span>' + escapeHtml(gcodeLines[i]) + '</div>';
                }
                container.innerHTML = html;
            }

            // Auto-scroll only if user hasn't scrolled recently
            if (gcodeCurrentLine > 0 && !userScrolling) {
                const lineHeight = 18;
                container.scrollTop = Math.max(0, (gcodeCurrentLine - 5) * lineHeight);
            }
        }

        // Track user scrolling
        document.getElementById('gcodeViewer').addEventListener('scroll', function() {
            userScrolling = true;
            clearTimeout(userScrollTimeout);
            // Resume auto-scroll after 5 seconds of no manual scrolling
            userScrollTimeout = setTimeout(() => { userScrolling = false; }, 5000);
        });

        function escapeHtml(text) {
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function setupCamera() {
            const cam = document.getElementById('camera');
            const img = document.createElement('img');
            img.src = CAMERA_URL;
            img.onerror = () => { cam.innerHTML = '<span>Camera unavailable</span>'; };
            img.onload = () => { cam.innerHTML = ''; cam.appendChild(img); };
        }

        // ========== INIT ==========
        connect();
        setupCamera();
        updateStepButtons();
        updateButtonStates();
    </script>
</body>
</html>
